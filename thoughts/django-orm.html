<!DOCTYPE HTML>
<html lang="en-GB" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Django ORM - The Programmer&#x27;s Compendium</title>


        <!-- Custom HTML head -->

        <meta name="description" content="My knowledge relating to software engineering.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Programmer&#x27;s Compendium</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/QasimK/programmers-compendium" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="django-orm"><a class="header" href="#django-orm">Django ORM</a></h1>
<p>Django has tight integration between relational databases, HTML, and REST APIs. By defining one model, you get a web interface to modify it, a database interface to query or modify it, and HTML interfaces (forms) to query/modify it. This is fantastic for rapid development.</p>
<p>So, if you're in that tightly-coupled ecosystem and legitimately making use of it, then bear those pros in mind.</p>
<p>I want to talk about when you're not using Django's Admin interface, and HTML forms and templates. This is much more likely for any large application.</p>
<p>Related Article: <a href="https://calpaterson.com/activerecord.html">https://calpaterson.com/activerecord.html</a></p>
<h2 id="the-pain"><a class="header" href="#the-pain">The pain</a></h2>
<p>Django's ORM follows</p>
<p>I want to talk about Django's ORM and my explain my thoughts on why I think it should be avoided.</p>
<h2 id="its-not-sql"><a class="header" href="#its-not-sql">It's not SQL</a></h2>
<p>Django goes out of its way to hide SQL, database principles and Python's standard interface to databases. This means less transferable knowledge is learnt, and actual understanding about databases is harder to come by.</p>
<p>SQLAlchemy maps much more directly onto</p>
<h3 id="joins"><a class="header" href="#joins">Joins</a></h3>
<p>Let's do a simple join:</p>
<pre><code class="language-python">Books.objects.filter(author__name="django")
</code></pre>
<p>It's not obvious at all that a join is happening.</p>
<h3 id="aggregates"><a class="header" href="#aggregates">Aggregates</a></h3>
<pre><code class="language-python">Book.objects.annotate(Count('chapters'))
</code></pre>
<p>vs</p>
<pre><code>SELECT book.*, count(chapter.id)
FROM book
JOIN chapter using (book_id);
</code></pre>
<h2 id="its-not-pythons-dbapi"><a class="header" href="#its-not-pythons-dbapi">It's not Python's DBAPI</a></h2>
<p>...</p>
<h2 id="it-hides-the-global-state"><a class="header" href="#it-hides-the-global-state">It hides the global state</a></h2>
<p>From <strong>anywhere</strong> you can call the database:</p>
<pre><code class="language-python">Book.objects.create()
</code></pre>
<p>That is actually pretty bad, but further this demonstrates that the database connection, cursor, session, transaction are all hidden away.</p>
<pre><code class="language-python">with Session(engine) as session:
    session.add(book)
    session.commit()
</code></pre>
<p>Further reading: https://docs.sqlalchemy.org/en/14/orm/session_transaction.html?highlight=savepoint#session-level-vs-engine-level-transaction-control</p>
<h2 id="it-uses-autocommit"><a class="header" href="#it-uses-autocommit">It uses autocommit</a></h2>
<p>By default, Django uses autocommit where every statement is immediately committed. This is against the PEP 249 standard and usually not what you want.</p>
<p>Complex applications often perform complex queries and mutations that must be kept consistent, and thus</p>
<p>To use a transaction:</p>
<pre><code class="language-python">with transaction.atomic(durable=True):
    obj1.save()
    obj2.save()
</code></pre>
<p>SQLAlchemy ORM:</p>
<pre><code class="language-python">with session.begin():
    session.add(obj1)
    session.add(obj2)
</code></pre>
<p>Further reading: https://docs.sqlalchemy.org/en/14/changelog/migration_20.html#library-level-but-not-driver-level-autocommit-removed-from-both-core-and-orm</p>
<h2 id="it-mixes-together-too-many-things"><a class="header" href="#it-mixes-together-too-many-things">It mixes together too many things</a></h2>
<ul>
<li>Model fields can define <code>blank</code> which is a client-side validation.</li>
<li>Model fields can define <code>verbose_name</code> which is for displaying to users.</li>
</ul>
<h2 id="its-not-clear-when-queries-are-executed"><a class="header" href="#its-not-clear-when-queries-are-executed">It's not clear when queries are executed</a></h2>
<p>There are a lot of rules on when a query is actually executed. I'll grant they're pretty straightforward, but there are edge cases to ensure multiple queries are not executed by accident.</p>
<pre><code class="language-python">results = Book.objects.all()
if len(results) &gt; 2:
    print(results)
</code></pre>
<p>In comparison, with SQLAlchemy there is an explicit execute:</p>
<pre><code class="language-python">results = session.execute(select(Book))
</code></pre>
<h2 id="complex-queries-are-nasty"><a class="header" href="#complex-queries-are-nasty">Complex queries are nasty</a></h2>
<p>SQLAlchemy has strong support for niche features in comparison to Django.</p>
<h2 id="transactions-are-a-mess"><a class="header" href="#transactions-are-a-mess">Transactions are a mess</a></h2>
<p>Though in Django 3.2, they finally added <code>transaction(durable=True)</code>, the whole transaction system is opaque.</p>
<h2 id="its-not-ddd-compatible"><a class="header" href="#its-not-ddd-compatible">It's not DDD-compatible</a></h2>
<p>Django forces you to define your models in the root of an "app", while with a good code structure the database models will be hidden away.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../thoughts/avoid-makefiles.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../thoughts/safe-writes.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../thoughts/avoid-makefiles.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../thoughts/safe-writes.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
