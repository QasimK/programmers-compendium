<!DOCTYPE HTML>
<html lang="en-GB" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Programmer&#x27;s Compendium</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="My knowledge relating to software engineering.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> The Programmer's Compendium</a></li><li class="chapter-item expanded affix "><li class="part-title">Recipes</li><li class="chapter-item expanded "><a href="recipes/nginx.html"><strong aria-hidden="true">2.</strong> Nginx</a></li><li class="chapter-item expanded "><a href="recipes/uwsgi.html"><strong aria-hidden="true">3.</strong> uWSGI</a></li><li class="chapter-item expanded "><a href="recipes/kubernetes.html"><strong aria-hidden="true">4.</strong> Kubernetes</a></li><li class="chapter-item expanded "><a href="recipes/gcloud.html"><strong aria-hidden="true">5.</strong> GCloud</a></li><li class="chapter-item expanded "><a href="recipes/postgres.html"><strong aria-hidden="true">6.</strong> Postgres</a></li><li class="chapter-item expanded affix "><li class="part-title">Python</li><li class="chapter-item expanded "><a href="topics/python.html"><strong aria-hidden="true">7.</strong> Python Misc.</a></li><li class="chapter-item expanded "><a href="python/profiling.html"><strong aria-hidden="true">8.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="python/versions.html"><strong aria-hidden="true">9.</strong> Versions</a></li><li class="chapter-item expanded "><a href="python/sqlalchemy.html"><strong aria-hidden="true">10.</strong> SQLAlchemy</a></li><li class="chapter-item expanded affix "><li class="part-title">Topics</li><li class="chapter-item expanded "><a href="topics/web.html"><strong aria-hidden="true">11.</strong> Web</a></li><li class="chapter-item expanded "><a href="topics/git.html"><strong aria-hidden="true">12.</strong> Git</a></li><li class="chapter-item expanded "><a href="topics/networking.html"><strong aria-hidden="true">13.</strong> Networking</a></li><li class="chapter-item expanded "><a href="topics/crypto.html"><strong aria-hidden="true">14.</strong> Crypto</a></li><li class="chapter-item expanded "><a href="topics/time.html"><strong aria-hidden="true">15.</strong> Time</a></li><li class="chapter-item expanded "><a href="topics/bash.html"><strong aria-hidden="true">16.</strong> Bash Scripts</a></li><li class="chapter-item expanded "><a href="topics/xml.html"><strong aria-hidden="true">17.</strong> XML</a></li><li class="chapter-item expanded affix "><li class="part-title">SQL/DB</li><li class="chapter-item expanded "><a href="sql/databases.html"><strong aria-hidden="true">18.</strong> Databases</a></li><li class="chapter-item expanded "><a href="sql/querying.html"><strong aria-hidden="true">19.</strong> Querying</a></li><li class="chapter-item expanded "><a href="sql/joins.html"><strong aria-hidden="true">20.</strong> Joins</a></li><li class="chapter-item expanded "><a href="sql/trust.html"><strong aria-hidden="true">21.</strong> Trust</a></li><li class="chapter-item expanded "><a href="sql/migrations.html"><strong aria-hidden="true">22.</strong> Migrations</a></li><li class="chapter-item expanded "><a href="sql/migrations-howto.html"><strong aria-hidden="true">23.</strong> Migrations-HOWTO</a></li><li class="chapter-item expanded "><a href="sql/postgres.html"><strong aria-hidden="true">24.</strong> Postgres</a></li><li class="chapter-item expanded affix "><li class="part-title">Linux</li><li class="chapter-item expanded "><a href="linux/overview.html"><strong aria-hidden="true">25.</strong> Overview</a></li><li class="chapter-item expanded "><a href="linux/systemd.html"><strong aria-hidden="true">26.</strong> Systemd</a></li><li class="chapter-item expanded "><a href="linux/shells.html"><strong aria-hidden="true">27.</strong> Shells</a></li><li class="chapter-item expanded "><a href="linux/ssh.html"><strong aria-hidden="true">28.</strong> SSH/Mosh</a></li><li class="chapter-item expanded "><a href="linux/containerisation.html"><strong aria-hidden="true">29.</strong> Containers</a></li><li class="chapter-item expanded "><a href="linux/terminal.html"><strong aria-hidden="true">30.</strong> Terminal Pro</a></li><li class="chapter-item expanded affix "><li class="part-title">Domains</li><li class="chapter-item expanded "><a href="domains/accounting.html"><strong aria-hidden="true">31.</strong> Accounting</a></li><li class="chapter-item expanded "><a href="domains/audio.html"><strong aria-hidden="true">32.</strong> Audio</a></li><li class="chapter-item expanded "><a href="domains/encoding.html"><strong aria-hidden="true">33.</strong> Encoding</a></li><li class="chapter-item expanded affix "><li class="part-title">Software Development</li><li class="chapter-item expanded "><a href="software-development/principles.html"><strong aria-hidden="true">34.</strong> Principles</a></li><li class="chapter-item expanded "><a href="software-development/design-patterns.html"><strong aria-hidden="true">35.</strong> Design Patterns</a></li><li class="chapter-item expanded "><a href="software-development/anti-patterns.html"><strong aria-hidden="true">36.</strong> Anti-patterns</a></li><li class="chapter-item expanded "><a href="software-development/testing.html"><strong aria-hidden="true">37.</strong> Testing</a></li><li class="chapter-item expanded "><a href="software-development/architecture-patterns.html"><strong aria-hidden="true">38.</strong> Architecture Patterns</a></li><li class="chapter-item expanded "><a href="software-development/apis.html"><strong aria-hidden="true">39.</strong> APIs</a></li><li class="chapter-item expanded "><a href="software-development/agile.html"><strong aria-hidden="true">40.</strong> Agile</a></li><li class="chapter-item expanded "><a href="software-development/refactoring.html"><strong aria-hidden="true">41.</strong> Refactoring</a></li><li class="chapter-item expanded "><a href="software-development/documentation.html"><strong aria-hidden="true">42.</strong> Documentation</a></li><li class="chapter-item expanded "><a href="software-development/estimating.html"><strong aria-hidden="true">43.</strong> Estimating</a></li><li class="chapter-item expanded "><a href="software-development/ddd.html"><strong aria-hidden="true">44.</strong> DDD</a></li><li class="chapter-item expanded affix "><li class="part-title">Fundamentals</li><li class="chapter-item expanded "><a href="core/cpu.html"><strong aria-hidden="true">45.</strong> CPU</a></li><li class="chapter-item expanded "><a href="core/sorting.html"><strong aria-hidden="true">46.</strong> Sorting</a></li><li class="chapter-item expanded "><a href="core/strings.html"><strong aria-hidden="true">47.</strong> Strings</a></li><li class="chapter-item expanded affix "><li class="part-title">Thoughts</li><li class="chapter-item expanded "><a href="thoughts/avoid-makefiles.html"><strong aria-hidden="true">48.</strong> Avoid Makefiles</a></li><li class="chapter-item expanded "><a href="thoughts/django-orm.html"><strong aria-hidden="true">49.</strong> Django ORM</a></li><li class="chapter-item expanded "><a href="thoughts/safe-writes.html"><strong aria-hidden="true">50.</strong> Safe Writes</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Appendix</li><li class="chapter-item expanded "><a href="appendix/reading-materials.html"><strong aria-hidden="true">51.</strong> Reading Materials</a></li><li class="chapter-item expanded "><a href="appendix/references.html"><strong aria-hidden="true">52.</strong> References</a></li><li class="chapter-item expanded "><a href="appendix/talk-notes.html"><strong aria-hidden="true">53.</strong> Talk Notes</a></li><li class="chapter-item expanded "><a href="appendix/know-thy-history.html"><strong aria-hidden="true">54.</strong> Know Thy History</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="ignore-me/maybes.html">Maybes-Todos-Snippets</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Programmer&#x27;s Compendium</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/QasimK/programmers-compendium" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-programmers-compendium"><a class="header" href="#the-programmers-compendium">The Programmer's Compendium</a></h1>
<p>Broken out into:</p>
<ul>
<li><strong>Recipes</strong> for setting up or using particular software/services</li>
<li><strong>Python</strong> because I do so much of it</li>
<li>Details about particular <strong>Topics</strong></li>
<li>Rundown of <strong>Linux</strong></li>
<li>Miscellaneous information about particular <strong>Domains</strong></li>
<li>General guidelines on <strong>Software Development</strong></li>
<li>Underlying <strong>Fundamentals</strong> of programming</li>
</ul>
<p>Other resources include:</p>
<ul>
<li><a href="https://github.com/QasimK/my-setup" title="How to setup a computer for software development">My Setup</a> - How to setup a computer for software development.</li>
<li><a href="https://github.com/QasimK/learn-it">Learn It</a> - The predecessor to this book.</li>
</ul>
<hr />
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/"><img src="./cc-by-sa.png" alt="Creative Commons License" title="Creative Commons License" /></a>
<br>
This work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx"><a class="header" href="#nginx">Nginx</a></h1>
<blockquote>
<p>Config Generator: <a href="https://nginxconfig.io/">https://nginxconfig.io/</a></p>
</blockquote>
<p>Nginx is a reverse proxy, allowing a single port to host multiple websites.</p>
<ul>
<li><code>add_header</code> <a href="https://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header">does not inherit</a> properly.</li>
</ul>
<h2 id="global-configurations"><a class="header" href="#global-configurations">Global configurations</a></h2>
<p>Global configuration (<code>http</code> block-level) can be placed inside <code>/etc/nginx/conf.d/*.conf</code>.</p>
<h3 id="tls"><a class="header" href="#tls">TLS</a></h3>
<pre><code class="language-nginx"># tls.conf
# Configure TLS security (requires setting parameters in server blocks to activate)

# USAGE:
# You must generate a dhparam.pem file.
# You must set ssl_certificate, ssl_certificate_key, and ssl_trusted_certificate.
# You must NOT use add_header inside your server {} block at all.

ssl_session_cache shared:SSL:10M;
ssl_session_timeout 180m;
ssl_session_tickets off;

# Secure SSL config - https://mozilla.github.io/server-side-tls/ssl-config-generator/
ssl_protocols TLSv1.2 TLSv1.3;
ssl_dhparam /etc/ssl/certs/dhparam.pem;  # Must generate this manually
ssl_ciphers ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;

# Already set in /etc/nginx/nginx.conf
# ssl_prefer_server_ciphers on;

# SSL OSCP Stapling
ssl_stapling on;
ssl_stapling_verify on;
resolver 8.8.8.8 8.8.4.4;

# Force SSL to this domain (+subdomains) for 6 months (+ preload list)
add_header Strict-Transport-Security &quot;max-age=15768000; includeSubDomains; preload&quot; always;
</code></pre>
<h3 id="security-headers"><a class="header" href="#security-headers">Security Headers</a></h3>
<p>There are several headers used for security, which can be set by Nginx or by your application. The following global configuration file will set a default if upstream has not provided one.</p>
<pre><code class="language-nginx"># security_headers.conf
# Ensure HTTP headers that are important for security are set.
# We set some defaults which can be overridden by the upstream server.

# USAGE:
# You must use proxy_hide_header/uwsgi_hide_header to hide the upstream
#   headers for all headers that we list below.
# You must NOT use add_header inside your server {} block at all.

map $upstream_http_referrer_policy $referrer_policy {
    default $upstream_http_referrer_policy;
    '' &quot;strict-origin-when-cross-origin&quot;;
}

map $upstream_http_x_content_type_options $x_content_type_options {
    default $upstream_http_x_content_type_options;
    '' &quot;nosniff&quot;;
}

map $upstream_http_x_frame_options $x_frame_options {
    default $upstream_http_x_frame_options;
    '' &quot;DENY&quot;;
}

map $upstream_http_x_xss_protection $x_xss_protection {
    default $upstream_http_x_xss_protection;
    '' &quot;1; mode=block&quot;;
}

add_header Referrer-Policy $referrer_policy always;
add_header X-Content-Type-Options $x_content_type_options always;
add_header X-Frame-Options $x_frame_options always;
add_header X-XSS-Protection $x_xss_protection always;
</code></pre>
<blockquote>
<p>Note:: X-XSS-Protection has been superseded with Content Security Policies (CSPs)</p>
<p>Note: X-Frame-Options has been superseded with the frame-ancestors CSP</p>
<p>TODO: Deny the use of browser features (Feature Policies)</p>
<p>TODO: Deny the use of cross-site features (Content Security Policies)</p>
</blockquote>
<h2 id="servers"><a class="header" href="#servers">Servers</a></h2>
<p>Servers can be configured inside <code>/etc/nginx/sites-available/</code>, but a symlink should be created inside <code>/etc/nginx/sites-enabled/</code> for them to become active.</p>
<h3 id="default-server---redirect-to-https"><a class="header" href="#default-server---redirect-to-https">Default Server - Redirect to HTTPS</a></h3>
<pre><code class="language-nginx">server {
    listen {{ public_ipv4 }}:80 default_server;
    listen [{{ public_ipv6 }}]:80 default_server;

    # Redirect all HTTP requests to HTTPS with a 301 Moved Permanently response.
    return 301 https://$host$request_uri;
}
</code></pre>
<h3 id="default-server---prevent-non-sni-traffic"><a class="header" href="#default-server---prevent-non-sni-traffic">Default Server - Prevent non-SNI Traffic</a></h3>
<pre><code class="language-nginx"># HTTPS default server for non-SNI requests
# Prevents an otherwise random public server certificate being leaked
# Also captures SNI requests where we are not hosting that domain here
server {
    listen {{ public_ipv4 }}:443 default_server;
    listen [{{ public_ipv6 }}]:443 default_server;
    server_name _;
    ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
    return 444;
}
</code></pre>
<h3 id="a-https-server"><a class="header" href="#a-https-server">A HTTPS Server</a></h3>
<pre><code class="language-nginx">server {
    listen {{ public_ipv4 }}:443 ssl http2;
    listen [{{ public_ipv6 }}]:443 ssl http2;
    server_name {{ domain }};
    charset utf-8;

    # Check if this certificate is really served for this server_name
    # https://serverfault.com/questions/578648/properly-setting-up-a-default-nginx-server-for-https
    if ($host != $server_name) {
        return 444;
    }

    # Certificate
    ssl_certificate /etc/letsencrypt/live/{{ domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ domain }}/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/{{ domain }}/chain.pem;

    # Lets Encrypt SSL Cert renewal
    location ~ /.well-known/acme-challenge {
        allow all;
        root /var/www/letsencrypt;
    }
}
</code></pre>
<ul>
<li>Ubuntu's Nginx configuration does a lot of things itself including: sendfile, tcp_nopush, tcpnodelay, keepalive_timeout, gzip, basic SSL configuration.</li>
<li>Doing <code>listen [::]:443 ipv6only=off</code> does not seem to work well (maybe due to use of IP addresses on other servers?). It is also Linux-only.</li>
</ul>
<h2 id="serving-files--upstream-proxies"><a class="header" href="#serving-files--upstream-proxies">Serving Files &amp; Upstream Proxies</a></h2>
<h3 id="uwsgi-proxy"><a class="header" href="#uwsgi-proxy">uWSGI Proxy</a></h3>
<pre><code class="language-nginx">upstream uwsgicluster {
    server unix:///run/uwsgi/app/APP_NAME/socket;
}

server {
    ...

    # Proxying connections to application servers
    location / {
        include         uwsgi_params;
        uwsgi_pass      uwsgicluster;

        uwsgi_param     Host $host;
        uwsgi_param     X-Real-IP $remote_addr;
        uwsgi_param     X-Forwarded-For $proxy_add_x_forwarded_for;
        uwsgi_param     X-Forwarded-Host $server_name;
        uwsgi_param     X-Forwarded-Proto $scheme;
        uwsgi_param     X-Forwarded-Port $server_port;

        # Correct handling of fallbacks for HTTP headers
        uwsgi_hide_header   Referrer-Policy;
        uwsgi_hide_header   X-Content-Type-Options;
        uwsgi_hide_header   X-Frame-Options;
        uwsgi_hide_header   X-XSS-Protection;
    }
}
</code></pre>
<h3 id="http-proxy"><a class="header" href="#http-proxy">HTTP Proxy</a></h3>
<pre><code class="language-nginx">server {
    ...

    # Proxying connections to application servers
    location / {
        proxy_pass         http://localhost:8080;
        # Required to rewrite &quot;Location&quot; header for Jenkins
        proxy_redirect     http://localhost:8080 https://{{ domain }};
        proxy_read_timeout 60;
        proxy_http_version 1.1;

        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Host $server_name;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Forwarded-Port $server_port;

        # Correct handling of fallbacks for HTTP headers
        proxy_hide_header  Referrer-Policy;
        proxy_hide_header  X-Content-Type-Options;
        proxy_hide_header  X-Frame-Options;
        proxy_hide_header  X-XSS-Protection;
    }
}
</code></pre>
<h3 id="serving-static-files"><a class="header" href="#serving-static-files">Serving Static Files</a></h3>
<pre><code class="language-nginx">server {
    ...

    # Serve static files
    rewrite ^/robots.txt /static/$request_uri last;
    location /static/ {
        alias /var/www-data/static/;
        disable_symlinks if_not_owner;  # Extra-security
        gzip_static on;

        # Performance
        # access_log off;
        open_file_cache         max=1000;
        open_file_cache_errors  on;
    }
}
</code></pre>
<p>A neat command to compress static files: <code>find -L . -type f ! -iname &quot;*.gz&quot; ! -iname &quot;*.png&quot; ! -iname &quot;*.jpg&quot; ! -iname &quot;*.jpeg&quot; ! -iname &quot;*.gif&quot; ! -iname &quot;*.webp&quot; ! -iname &quot;*.heif&quot; -exec gzip --best -kf &quot;{}&quot; \;</code></p>
<h2 id="performancetuning"><a class="header" href="#performancetuning">Performance/Tuning</a></h2>
<ul>
<li>sendfile - directly from kernel to network socket - covered by Ubuntu, but consider adding <code>sendfile_max_chunk</code>
<ul>
<li>Note that this does not work with gzip!</li>
</ul>
</li>
<li>open_file_cache - do not recheck filesystem for file on every request</li>
<li>gzip - covered by Ubuntu for HTML only...</li>
<li>gzip_static - do not compress on the fly, serve pre-generated .gz files</li>
<li>limit_req - consider for <a href="https://www.nginx.com/blog/rate-limiting-nginx/">rate limiting number-of-requests</a> by IP</li>
<li>(limit_conn - consider for rate limiting number-of-requests by connections - alternative to above?)</li>
<li>limit_rate - consider for limiting a individual request by limiting the network speed</li>
</ul>
<pre><code class="language-nginx"># Rate limit all requests for a server by IP address
limit_req_zone $binary_remote_addr zone=myzone:10m rate=1r/s;

server {
    ...

    limit_req_status 429;
    limit_req zone=myzone burst=60 nodelay;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uwsgi"><a class="header" href="#uwsgi">uWSGI</a></h1>
<blockquote>
<p>gunicorn is an alternative that may be simpler to use.</p>
</blockquote>
<p>The documentation that likes telling stories. uWSGI has a stupid <em>insane</em> number of features.</p>
<p>uWSGI is best combined with a web-server like Nginx: better at serving static files, the reverse-proxy buffers requests before forwarding to avoid wasting app-workers' time (<a href="https://en.wikipedia.org/wiki/Slowloris">Slowloris</a> DOS), and possibly better security. Other app-servers may not have the latter issue.</p>
<pre><code class="language-ini">[uwsgi]
; Increased efficiency for larger number of processes(/threads) (no reason not to).
thunder-lock = True

; (Threads disabled)
processes = 2
harakiri = 30

; uwsgitop &lt;stats-socket&gt;
stats = /run/uwsgi/app/APP_NAME/stats-socket
memory-report = True
; Clear environment on exit
vacuum = True

REPLACE_ME_HOST_NAME otherwise return HTTP 421 Misdirected Request (security)
route-if-not = equal:${HTTP_HOST};REPLACE_ME_HOST_NAME return:421
</code></pre>
<ul>
<li>Due to uWSGI's default pre-forking behaviour, you may want <code>lazy-apps</code> or a <code>@postfork</code> fix function when running more than one process.</li>
<li>Note on <code>harakiri</code> and &quot;post buffering&quot; - the web server should take entire request body before passing it on, otherwise a slow upload could be killed due to the harakiri timer.</li>
<li>When using threads, e.g.<code>threads=2</code>, will automatically set <code>enable-threads = true</code>.</li>
</ul>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li>Standard HTTP/TLS/SNI/WebSocket/Static Files/Async Apps</li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/AlarmSubsystem.html">Notifications</a></li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/RPC.html">Remote Procedure Call</a></li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/StatsServer.html">Stats Server</a></li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/Metrics.html">Metrics Collection</a></li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/Namespaces.html">App Security Jails</a> (Namespaces)</li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/Cgroups.html">App Resource Limits</a> (Cgroups)</li>
<li>Auto-scaling (<a href="https://uwsgi-docs.readthedocs.io/en/latest/Zerg.html">Zergs</a>, <a href="https://uwsgi-docs.readthedocs.io/en/latest/Broodlord.html">Broodlord</a>, <a href="https://uwsgi-docs.readthedocs.io/en/latest/Cheaper.html">Cheaper</a>)</li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/KSM.html">Memory deduplication</a></li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/Signals.html">Custom Signals</a> (target: workers/spoolers/mules/farms; event: custom/filesystem/timers/cron)</li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/Caching.html">Caches</a> (SharedMemory)</li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/Queue.html">Queues</a></li>
<li>Background tasks (<a href="https://uwsgi-docs.readthedocs.io/en/latest/Mules.html">mules</a>, <a href="https://uwsgi-docs.readthedocs.io/en/latest/Spooler.html">spoolers</a>)
<ul>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/Cron.html">Cron &amp; Timers</a></li>
</ul>
</li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/Locks.html">Locks</a></li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/InternalRouting.html">Routing</a> (requests, cache)</li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/Legion.html">Legion</a> (Failover?)</li>
</ul>
<h2 id="python-specific-configuration"><a class="header" href="#python-specific-configuration">Python-Specific Configuration</a></h2>
<p>uWSGI has an easy interface (<a href="https://pypi.python.org/pypi/uwsgidecorators/">uwsgidecorators</a>) to:</p>
<ul>
<li>Background tasks (spooler, mules, cron, timers, and generic execute-task-in-background-thread)</li>
<li>Communcation between all processes using signals</li>
<li>Locks</li>
<li><a href="https://uwsgi-docs.readthedocs.io/en/latest/Caching.html">In-memory cache</a> (with periodic disk sync)</li>
</ul>
<p>They are shared only within that master uWSGI instance.</p>
<pre><code class="language-ini">; Python
plugin = python3
virtualenv = /home/APP_NAME/virtualenv/
chdir = /home/APP_NAME/APP_DIR/
module = APP_NAME.wsgi:application

; Background Tasks
spooler = /home/APP_NAME/tasks/
import = APP_NAME.tasks

; Real time tracebacks (inc. for harakiri'd requests)
; uwsgi --connect-and-read /run/uwsgi/app/APP_NAME/tracebacker1
py-tracebacker = /run/uwsgi/app/APP_NAME/tracebacker

; Only when running  application
; single-interpreter = true
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kubernetes"><a class="header" href="#kubernetes">Kubernetes</a></h1>
<h2 id="commands"><a class="header" href="#commands">Commands</a></h2>
<h3 id="running-as-a-different-user"><a class="header" href="#running-as-a-different-user">Running as a different user</a></h3>
<p>Work around for K8S not supporting --user flag: <a href="https://github.com/kubernetes/kubernetes/issues/30656">https://github.com/kubernetes/kubernetes/issues/30656</a></p>
<pre><code class="language-console">kubectl get pods
kubectl describe pod &lt;POD-NAME&gt; | grep Node
gcloud compute ssh &quot;&lt;NODE-NAME&gt;&quot;
sudo su - root
docker ps | grep &lt;POD-NAME&gt;
docker exec -it -uroot &lt;ID&gt; /bin/bash
</code></pre>
<h2 id="api-deployment"><a class="header" href="#api-deployment">API Deployment</a></h2>
<p>Use k8syaml.com</p>
<pre><code class="language-yaml">spec:
    replicas: 2
    # How long before deployment of a new pod is considered failed  (default: 600)
    progressDeadlineSeconds: 180

    # Rolling updates
    strategy:
        type: RollingUpdate
        rollingUpdate:
            # (Surge is rounded up)
            maxSurge: 25%
            maxUnavailable: 0

    # Container(s)
    template:
        spec:
            # List of containers
            containers:
              - image: &lt;url&gt;
                imagePullPolicy: IfNotPresent

                # Health checks: startupProbe, readinessProbe, livenessProbe
                # startupProbe = when static initialDelaySeconds is bad fit

                # readinessProbe = should kubelet direct traffic?
                readinessProbe:
                    httpGet:
                        path: /healthz
                        port: 5000
                        scheme: HTTP
                    initialDelaySeconds: 10
                    periodSeconds: 10
                    successThreshold: 1
                    failureThreshold: 3
                    timeoutSeconds: 5

                # livenessProbe = should kubelet restart pod?
                livenessProbe:
                    httpGet:
                        path: /healthz
                        port: 5000
                        scheme: HTTP
                    initialDelaySeconds: 10
                    periodSeconds: 10
                    successThreshold: 1
                    failureThreshold: 3
                    timeoutSeconds: 10

                resources:
                    requests:
                        memory: &quot;192Mi&quot;
                        cpu: 0.1
                    limits:
                        memory: &quot;256Mi&quot;
                        cpu: 1

                command: []

            restartPolicy: Always (default)

            # How long between SIGTERM and SIGKILL (default: 30)
            terminationGracePeriodSeconds: 10
---
# Protect against voluntary disruptions (node stuff)
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
spec:
    maxUnavailable: 1
---
# Horizontal Auto-scaler
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
spec:
    minReplicas: 1
    maxReplicas: 4
    scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: &lt;name&gt;
    targetCPUUtilizationPercentage: 50
---
# Load balancer / Service

</code></pre>
<p>Tips:</p>
<ul>
<li>livenessProbe - do not check dependencies
<ul>
<li>be wary of temp. long responses causing one restart =&gt; cascading restarts</li>
<li>use timeout of client timeout and forgiving failureThreshold</li>
<li>set initialDelaySeconds so that containers always have enough time</li>
</ul>
</li>
<li>readinessProbe - check dependencies [or not, see below]
<ul>
<li>if shared dependency (database) try not to fail probe because all pods will fail!
<ul>
<li>especially have a large timeout for these checks</li>
</ul>
</li>
<li>if truly independent, you're okay</li>
<li>probably don't need one anyway for upstream servies
<ul>
<li>let application return error immediately (503)</li>
<li>better than timeout/404/etc.</li>
</ul>
</li>
<li>note: still need readinessProbe to fail deployment of new ReplicaSet!</li>
</ul>
</li>
<li>pod can be ready:0/1 with status:RUNNING but not accepting traffic!</li>
</ul>
<p>How to handle ready checking dependencies that not all endpoints use?
* probably better not to check dependencies in readinessProbe at all
* for shared dependencies, how likely is it that <em>just</em> this pod has a problem</p>
<p>Using readiness probe to check for misconfiguration?
* Better to use startupProbe, but what happens if dependency itself is down?
* You don't want to block new deployments due to dependency!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="google-cloud"><a class="header" href="#google-cloud">Google Cloud</a></h1>
<ul>
<li>Get databases: <code>gcloud sql instances list</code></li>
<li>Get secrets: <code>kubectl get secret</code>
<ul>
<li>Get password: <code>kubectl get secret KEY -o jsonpath --template {.data.password}</code></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="postgres"><a class="header" href="#postgres">Postgres</a></h1>
<h2 id="executing-queries-against-the-replica"><a class="header" href="#executing-queries-against-the-replica">Executing queries against the replica</a></h2>
<blockquote>
<p>ERROR: canceling statement due to conflict with recovery</p>
<p>Detail: User query might have needed to see row versions that must be removed</p>
</blockquote>
<p>The <a href="https://stackoverflow.com/questions/14592436/postgresql-error-canceling-statement-due-to-conflict-with-recovery">preferred solution</a> is to allow the replica to pause applying the received WAL logs while a query executes:</p>
<pre><code class="language-ini"># /etc/postgresql/10/main/postgresql.conf on a slave
max_standby_archive_delay = 900s
max_standby_streaming_delay = 900s
</code></pre>
<p>This is a cumulative delay - if multiple queries a running, then the last one might get terminated after just a second because the total time limit has been reached.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="python"><a class="header" href="#python">Python</a></h1>
<ul>
<li>Use <a href="https://pypi.org/project/pipx/">pipx</a> to install environment management tools and scripts. (Execute binaries installed in isolated virtual environments.)</li>
<li>Use <a href="https://python-poetry.org/">Poetry</a> to manage packaging and dependencies.</li>
</ul>
<p>Hey, there's already a <a href="http://docs.python-guide.org/en/latest/">Hitchhiker's Guide to Python</a>! This is quite comprehensive on the Python <em>development</em> basics.</p>
<h2 id="gil"><a class="header" href="#gil">GIL</a></h2>
<p>GIL required to run bytecode, but not when waiting on I/O - can switch to different thread. CPython has macros to release and re-aquire GIL which can be used if extension does not need to run python bytecode/do any kind of ref-count changes (e.g. sleep, read/write files, network socket, numpy, image processing(?)). Cannot share GIL in CPU-bound code. CPU-bound &quot;check&quot; every 100 ticks to allow switching. Note: I/O doesn't often block unless you are flushing - OS buffers. Note: Threads/Processes result in CPU context switches, while async does not.</p>
<p>Pure CPU: Process &lt;---&gt; Threads &lt;---&gt; Async: Pure I/O (Many &quot;Connections&quot;/Slow I/O).</p>
<p>Async I/O clearly delineates the context switch locations, in theory.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Processes</th><th style="text-align: left">Threads</th><th style="text-align: left">Async I/O</th></tr></thead><tbody>
<tr><td style="text-align: left"></td><td style="text-align: left"></td><td style="text-align: left">No CPU Context Switches</td></tr>
<tr><td style="text-align: left"></td><td style="text-align: left">Shared memory can result in race conditions.</td><td style="text-align: left">No race conditions.. usually.</td></tr>
<tr><td style="text-align: left"></td><td style="text-align: left"></td><td style="text-align: left">No dead locks.. usually.</td></tr>
<tr><td style="text-align: left">Costly.</td><td style="text-align: left">Each thread has its own stack.</td><td style="text-align: left">Shared Stack. Uses an executor pool to run sync tasks in a background thread (this uses additional resources)</td></tr>
</tbody></table>
</div>
<p>Python 2 -&gt; 3: Strings/Bytes, Print, Super() - new style classes, division.</p>
<h2 id="linting"><a class="header" href="#linting">Linting</a></h2>
<ul>
<li>black (<a href="https://engineering.depop.com/implementing-python-black-on-a-legacy-codebase-35b37f10ce18">how-to</a>)</li>
<li>flake8
<ul>
<li>pycodestyle (formerly pep8)</li>
<li>pyflakes</li>
<li>mccabe</li>
</ul>
</li>
<li>pylint</li>
<li>bandit/dodgy/safety(pipenv)</li>
<li>prospector</li>
<li>isort</li>
<li><a href="https://github.com/seddonym/layer_linter">Layer Linter</a> (not tried)</li>
<li>pydocstyle</li>
<li>mypy</li>
<li>vulture</li>
<li>pyroma for libraries (setup.py)</li>
</ul>
<h2 id="libraries"><a class="header" href="#libraries">Libraries</a></h2>
<ul>
<li><a href="https://passlib.readthedocs.io/">passlib</a> - high-level secrets library</li>
<li><a href="https://github.com/cool-RR/pysnooper">pysnooper</a> - line-by-line print debugging</li>
<li><a href="https://boltons.readthedocs.io/en/latest/">boltons</a> - &quot;boltons should be buitins&quot; (stdlib additions)</li>
<li>[freezegun]</li>
</ul>
<h3 id="pytest"><a class="header" href="#pytest">Pytest</a></h3>
<p>See <a href="https://github.com/QasimK/learn-it/blob/master/pytest-cheat-sheet.md">my cheat sheet</a>.</p>
<p>Useful plugins:</p>
<ul>
<li>pytest-randomly</li>
<li>pytest-datadir</li>
<li>pytest-bdd</li>
</ul>
<p>Stop network calls:</p>
<pre><code class="language-py">import socket
def stop_network_calls(monkeypatch)
    def _socket(*_, **__):
        raise Exception()
    monkeypatch.setattr(socket, &quot;socket&quot;, _socket)

</code></pre>
<p>Randomise time-zones:</p>
<pre><code class="language-py">import os, random, pytest
from _pytest.monkeypatch import MonkeyPatch

@pytest.fixture(scope=&quot;session&quot;)
def monkeysession():
    mpatch = MonkeyPatch()
    yield mpatch
    mpatch.undo()

@pytest.fixture(autouse=True, scope=&quot;session&quot;)
def randomise_timezone(monkeysession):
    monkeysession.setenv(&quot;TZ&quot;, random.choice([&quot;Europe/London&quot;]))
</code></pre>
<h3 id="sqlalchemy"><a class="header" href="#sqlalchemy">SQLAlchemy</a></h3>
<ul>
<li>Remember to index on ForeignKeys. Postgres does not do this automatically. MySQL always does this.</li>
<li>Remember to set <code>onupdate</code> and <code>ondelete</code> cascades on ForeignKeys.</li>
<li>To prevent spurious joins: (this cannot be used with NULLable outer joins)
<pre><code class="language-py">session.query(Model).options(
    sa.orm.joinedload(&quot;child&quot;).joinedload(&quot;grandchild&quot;),
    sa.orm.raiseload(&quot;*&quot;),
)
</code></pre>
</li>
</ul>
<h3 id="pandas"><a class="header" href="#pandas">Pandas</a></h3>
<p>Understanding <a href="https://towardsdatascience.com/understanding-settingwithcopywarning-7142952a01fa">SettingWithCopyWarning</a>.</p>
<p>Raising it as an error (<code>setup.cfg</code>)</p>
<pre><code class="language-ini">[tool:pytest]
filterwarnings =
    error::pandas.core.common.SettingWithCopyWarning
    error::FutureWarning
</code></pre>
<h2 id="gotchas"><a class="header" href="#gotchas">Gotchas</a></h2>
<p>Probably the last one you will learn:</p>
<pre><code class="language-py">x = [1,2,3,4]
lambdas = [
   lambda: x[i]
   for i in range(4)
]

[f() for f in lambdas]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="python-profiling--performance"><a class="header" href="#python-profiling--performance">Python Profiling &amp; Performance</a></h1>
<h2 id="profiling-methods"><a class="header" href="#profiling-methods">Profiling Methods</a></h2>
<pre><code class="language-console">python -m cProfile -o out.prof do.py
</code></pre>
<h2 id="visualisation"><a class="header" href="#visualisation">Visualisation</a></h2>
<p>Use <a href="https://jiffyclub.github.io/snakeviz/">snakeviz</a>.</p>
<p>Install <code>pipx install snakeviz</code>.</p>
<pre><code class="language-console">snakeviz out.prof
</code></pre>
<h2 id="other"><a class="header" href="#other">Other</a></h2>
<p><a href="https://github.com/P403n1x87/austin">Austin</a>.</p>
<pre><code class="language-console">austin -f -o out.prof python3 do.py
</code></pre>
<p>Austin can attach to running programs.</p>
<p>I haven't worked out how to visualise this.</p>
<h2 id="performance-tips"><a class="header" href="#performance-tips">Performance Tips</a></h2>
<h3 id="sqlalchemy-1"><a class="header" href="#sqlalchemy-1">SQLAlchemy</a></h3>
<p>Something something 'raise' to prevent hidden n+1 joins.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="python-history"><a class="header" href="#python-history">Python History</a></h1>
<h2 id="python-311"><a class="header" href="#python-311">Python 3.11</a></h2>
<ul>
<li>exception groups and <code>except*</code> syntax</li>
<li>asyncio task groups  <code>TaskGroup</code></li>
<li>add context to exceptions using <code>add_note</code></li>
<li><code>datetime.UTC</code> alias</li>
<li>date and time support for <code>fromisoformat</code></li>
<li><code>StrEnum</code></li>
<li>enum verification checks <code>verify</code></li>
<li><code>operator.call</code></li>
<li>type hints <code>Self</code> and <code>LiteralString</code></li>
<li>typing <code>assert_never</code> and <code>reveal_type</code></li>
</ul>
<h2 id="python-310"><a class="header" href="#python-310">Python 3.10</a></h2>
<ul>
<li>structural pattern matching <code>match</code></li>
<li>context managers can be defined across multiple lines</li>
<li>union operator for type hints <code>X | Y</code></li>
<li>type hint guarding <code>TypeGuard</code></li>
<li>itertools <code>pairwise</code></li>
</ul>
<h2 id="python-39"><a class="header" href="#python-39">Python 3.9</a></h2>
<ul>
<li>time zone support built-in with <code>zoneinfo</code> module</li>
<li>in-place union <code>|=</code> of dictionary-like objects</li>
<li>combined annotations <code>Annotated[float, &quot;seconds&quot;]</code></li>
<li>type hint containers directly <code>list[float]</code></li>
<li>more flexible decorator syntax</li>
<li>string <code>removeprefix</code> and <code>removesuffix</code></li>
<li>maths <code>gcd</code> and <code>lcm</code></li>
</ul>
<h2 id="python-38"><a class="header" href="#python-38">Python 3.8</a></h2>
<ul>
<li>assignment expressions <code>if (n := len(a)) &gt; 10:</code></li>
<li>improved f-strings <code>f&quot;{x*9 + 15=}&quot;</code></li>
<li>positional and keyword only parameters</li>
<li>multiprocessing.shared_memory</li>
</ul>
<h2 id="python-37"><a class="header" href="#python-37">Python 3.7:</a></h2>
<ul>
<li>dataclasses TBD: talk link.</li>
<li>contextvars</li>
<li>breakpoint()</li>
<li>postponed evaluation of type annotations</li>
<li>dicts officially respect insertion-order</li>
<li>time - nanosecond resolution functions</li>
<li><code>f&quot;{number:,}</code></li>
</ul>
<h2 id="python-36"><a class="header" href="#python-36">Python 3.6:</a></h2>
<ul>
<li>f-string literals</li>
<li>underscores in numeric literals</li>
<li>extended variable annotations</li>
<li>(async generators &amp; comprehensions)</li>
<li>Local Time Disambiguation</li>
<li>secrets module</li>
</ul>
<h2 id="python-31---35"><a class="header" href="#python-31---35">Python 3.1 - 3.5</a></h2>
<p>Skipped</p>
<h2 id="python-3000"><a class="header" href="#python-3000">Python 3000:</a></h2>
<ul>
<li>unicode vs bytes</li>
<li>print() vs print</li>
<li>division float vs int</li>
<li>new-style vs classic classes</li>
<li>relative imports (?)</li>
<li>views and iterators vs lists (e.g. dict.items() == dict.iteritems())</li>
<li>nonlocal</li>
<li>extended iterable unpacking</li>
<li>set literals</li>
<li>removed tuple parameter unpacking</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-sqlalchemy-in-python"><a class="header" href="#using-sqlalchemy-in-python">Using SQLAlchemy in Python</a></h1>
<p>SQLAlchemy is an absolutely outstanding, best-in-class ORM library.</p>
<p><em>However</em>, the default setup is not perfect.</p>
<h2 id="idle-in-transaction"><a class="header" href="#idle-in-transaction">Idle in Transaction</a></h2>
<p>The default behaviour in SQLAlchemy is to open a transaction for read queries.</p>
<p>However, read queries (inside a transaction), will block all database migrations.</p>
<p>Considering, that migrations block all subsequent query requests, this can take down an application.</p>
<p>Thus, even small transactions can become a serious problem.</p>
<p>In particular, consider when sessions are tied to web requestsâ€”a transaction could be open for several seconds.</p>
<h3 id="recommendation"><a class="header" href="#recommendation">Recommendation</a></h3>
<p>When using the usual READ COMMITTED isolation level:</p>
<ul>
<li>use auto-commit for reads</li>
<li>switch to explicit transactions for writes</li>
</ul>
<p>Problem description and alternate solution: <a href="https://www.gorgias.com/blog/prevent-idle-in-transaction-engineering">https://www.gorgias.com/blog/prevent-idle-in-transaction-engineering</a>
<a href="https://www.oddbird.net/2014/06/14/sqlalchemy-postgres-autocommit/">https://www.oddbird.net/2014/06/14/sqlalchemy-postgres-autocommit/</a></p>
<h2 id="weakly-referenced-objects"><a class="header" href="#weakly-referenced-objects">Weakly Referenced Objects</a></h2>
<p>SQLAlchemy weakly references ORM instances. This means, when you convert them into a core type, they are dropped from the identity map.</p>
<p>The impact is that when it comes to updates, SQLAlchemy will have to inefficiently query the database for the object again.</p>
<h3 id="recommendation-1"><a class="header" href="#recommendation-1">Recommendation</a></h3>
<p>Use <a href="https://docs.sqlalchemy.org/en/20/orm/session_state_management.html#session-referencing-behavior">SQLAlchemy's recipe for strong references</a>.</p>
<h2 id="good-to-know"><a class="header" href="#good-to-know">Good to Know</a></h2>
<ul>
<li>SQLAlchemy has an identity map that caches queried objects</li>
<li>SQLAlchemy using mutation tracking and updates the precise fields that changed</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="web"><a class="header" href="#web">Web</a></h1>
<p>Learning: <a href="https://hpbn.co/">https://hpbn.co/</a></p>
<p><a href="https://google.github.io/styleguide/htmlcssguide.html">Google's Style Guide</a> has basic formatting and other guidance.</p>
<h2 id="minimal-html"><a class="header" href="#minimal-html">Minimal HTML</a></h2>
<pre><code class="language-HTML">&lt;!DOCTYPE html&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; /&gt;
&lt;title&gt;Saving bytes&lt;/title&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;styles.css&quot;&gt;
&lt;h1&gt;Let's go&lt;/h1&gt;
&lt;p&gt;Annddd we're done
</code></pre>
<h2 id="tools"><a class="header" href="#tools">Tools</a></h2>
<ul>
<li><a href="https://observatory.mozilla.org/">Mozilla Observatory</a> - web <strong>security</strong> checks (also links to a couple of the below)</li>
<li><a href="https://www.ssllabs.com/ssltest/">SSL Labs</a> - TLS <strong>security</strong> checker</li>
<li><a href="https://www.hardenize.com/">Hardenize</a> - domain/email/web <strong>security</strong> checks</li>
<li><a href="https://securityheaders.io/">SecurityHeaders</a> - <strong>security</strong> checks on HTTP headers</li>
</ul>
<h2 id="web-security"><a class="header" href="#web-security">Web Security</a></h2>
<ul>
<li>Same-Origin Policy (SOP). Security. (Related <a href="https://stackoverflow.com/a/43973018/197488">CORS</a> - not really security, just DRM.)
<ul>
<li>The Same Origin Policy (SOP) applies only to scripts accessing data from another origin.</li>
<li>CORS can be used to relax restrictions for scripts.</li>
<li>Websockets do not use SOP, the server must verify the <code>Origin:</code> header.</li>
<li>SOP does not prevent &quot;Simple Requests&quot; (e.g. HTML forms), but does prevent reading the response. This means <a href="https://stackoverflow.com/questions/33261244/why-same-origin-policy-isnt-enough-to-prevent-csrf-attacks#33324803">to prevent CSRF</a>, the server must verify the <code>Origin:</code> header.</li>
<li>Older browsers do not send the <code>Origin:</code> header.</li>
</ul>
</li>
<li>Content Security Policies let website owners control which resources they allow themselves [the links on the page] to load.
<ul>
<li>HTTP Headers and HTML meta tag intersect.</li>
</ul>
</li>
<li>Feature Policies let website owners control which permissions they allow themselves [the scripts on the page] to use.</li>
<li>Cross-Origin Resource Sharing let website owners allow which resources they allow others to load.
<ul>
<li>With exceptions that allow hotlinking for legacy resources images, scripts, css, and audio/video.</li>
<li>SOP applies to XHR, web fonts, and a couple of other things, and CORS can be used to relax these restrictions.</li>
</ul>
</li>
<li>CSRF - server accepting requests it believe came from the user (exploit server's trust in client)</li>
<li>XSS - inject scripts into the attacked website to bypass SOP (exploit client's trust in server - for XSS originating from server)
<ul>
<li>Reflected XSS, Persistent XSS, Self-XSS.</li>
<li>This game might be helpful: <a href="https://xss-game.appspot.com/">https://xss-game.appspot.com/</a></li>
</ul>
</li>
<li>Clickjacking</li>
<li>Storage access (cookies, sessionStorage, localStorage, IndexDB)</li>
<li>Remember: many (all?) of these headers are only needed on rendered content (HTML, not images)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git"><a class="header" href="#git">Git</a></h1>
<blockquote>
<p>Sometimes it feels like <a href="topics//stevelosh.com/blog/2013/04/git-koans/">git doesn't make sense</a>.</p>
<p>Squash merging is terrible and awful. It destroys histories and trashes attempts at re-using a branch <a href="https://stackoverflow.com/a/14343784">https://stackoverflow.com/a/14343784</a>. It is especially a bad idea on a large branch because git blame is likely far less usable. It is useful to ensure all commits pass tests for git bisect though. git slap everyone who introduced it in GitHub/BitBucket UIs.</p>
</blockquote>
<p>There's a neat interactive branching tutorial somewhere...</p>
<h2 id="tips--tricks"><a class="header" href="#tips--tricks">Tips &amp; Tricks</a></h2>
<p>Because git is huge.</p>
<ul>
<li><code>git log --first-parent</code> show only the first parent commit for merge commits.</li>
<li><code>git blame --ignore-rev 2e0ee159c</code> OR <code>git blame --ignore-revs-file &lt;file&gt;</code> to ignore something like a great reformatting commit.</li>
</ul>
<h2 id="security"><a class="header" href="#security">Security</a></h2>
<p>Sign tags not commits: <a href="http://git.661346.n2.nabble.com/GPG-signing-for-git-commit-td2582986.html">http://git.661346.n2.nabble.com/GPG-signing-for-git-commit-td2582986.html</a></p>
<p><a href="https://github.com/NicoHood/gpgit">https://github.com/NicoHood/gpgit</a></p>
<p>(Interesting read: <a href="https://mikegerwitz.com/papers/git-horror-story.html">https://mikegerwitz.com/papers/git-horror-story.html</a>)</p>
<h1 id="comparison"><a class="header" href="#comparison">Comparison</a></h1>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Concept</th><th style="text-align: left">Git</th><th style="text-align: left">Mercurial</th><th style="text-align: left">SVN</th></tr></thead><tbody>
<tr><td style="text-align: left">Branches</td><td style="text-align: left">Branches</td><td style="text-align: left">...</td><td style="text-align: left">...</td></tr>
<tr><td style="text-align: left">Stash</td><td style="text-align: left"></td><td style="text-align: left"></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: left">Working Area</td><td style="text-align: left"></td><td style="text-align: left"></td><td style="text-align: left"></td></tr>
<tr><td style="text-align: left">History</td><td style="text-align: left"></td><td style="text-align: left"></td><td style="text-align: left"></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="networking"><a class="header" href="#networking">Networking</a></h1>
<p>Private networks:</p>
<ul>
<li>10.0.0.0/8 (255.0.0.0)</li>
<li>192.168.0.0/16 (255.255.0.0)</li>
<li>172.16.0.0/12 (255.240.0.0)</li>
</ul>
<p>Connections(?):</p>
<p><a href="https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking/">https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking/</a></p>
<ul>
<li>Bridge (Like a Physical Network Switch)
<ul>
<li>One side of bridge gets IP addresses 10.0.0.2+. The bridge gateway would be 10.0.0.1</li>
<li>The other side is, i.e. the host IP 192.168.1.2+</li>
<li>NAT Port mapping required</li>
<li>Anything connected to the bridge can communicate with each other</li>
</ul>
</li>
<li>MACVLAN
<ul>
<li>Connect directly to network, get IP address on network</li>
<li>MAC address is virtualised on the NIC - requires promiscuous mode, usually not allowed on cloud</li>
<li>High Performance (no NAT/bridge)</li>
</ul>
</li>
<li>IPVLAN
* </li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="crypto"><a class="header" href="#crypto">Crypto</a></h1>
<p>You already know that you should never roll out your own crypto.</p>
<h2 id="password-hashing-one-way-key-derivation-functions"><a class="header" href="#password-hashing-one-way-key-derivation-functions">Password Hashing (One-way Key Derivation Functions)</a></h2>
<p>The hash may follow a scheme which encodes the KDF, for example <code>$method$params$salt$hash</code>.</p>
<ol>
<li>2018 state-of-the-art: <em>Argon2</em> (not standardised yet).
<ul>
<li>CPU, Memory, Parallelism-hard</li>
</ul>
</li>
<li>Scrypt</li>
<li>Bcrypt</li>
<li>PBKDF2</li>
</ol>
<p>Passwords are low-entropy data; you need to slow down attackers with access to vash parallel computation.</p>
<h2 id="cryptographic-hashing"><a class="header" href="#cryptographic-hashing">Cryptographic Hashing</a></h2>
<p>Designed to be fast while guaranteeing no collisions and no way of reversing the hash.</p>
<p>These are suitable for file integrity, message authentication, inputs for cryptographic signatures.</p>
<blockquote>
<p>There is yet another category of hasing functions used for dictionaries/hash tables :)</p>
</blockquote>
<h2 id="2fatotpu2f"><a class="header" href="#2fatotpu2f">2FA/TOTP/U2F</a></h2>
<h2 id="entropy"><a class="header" href="#entropy">Entropy</a></h2>
<p>Entropy is calculated using the password-generation function, not the password!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="time"><a class="header" href="#time">Time</a></h1>
<p>Use <a href="https://tools.ietf.org/html/rfc3339">RFC 3339</a> for dates and times, it is simpler than ISO 8601. However, it does not support durations.</p>
<p>There is a good article that I need to fine. I think the rules were:</p>
<ul>
<li>Be liberal in what you accept.</li>
<li>Store time as UTC</li>
<li>Store the symbolic time zone (i.e. &quot;Europe/London&quot;) if you need to know about daylight savings for further calculations.</li>
<li>Return time in UTC, and let the presentation layer convert it to the user's local time.</li>
</ul>
<p>Examples: <a href="http://www.creativedeletion.com/2015/01/28/falsehoods-programmers-date-time-zones.html">http://www.creativedeletion.com/2015/01/28/falsehoods-programmers-date-time-zones.html</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bash-sh-scripts"><a class="header" href="#bash-sh-scripts">Bash (sh) Scripts</a></h1>
<ul>
<li>Use <a href="https://www.shellcheck.net/">shellcheck</a> to lint</li>
</ul>
<h2 id="bash-template"><a class="header" href="#bash-template">Bash Template</a></h2>
<p>Use the following options for <a href="https://vaneyckt.io/posts/safer_bash_scripts_with_set_euxo_pipefail/">safer bash scripts</a>:</p>
<pre><code class="language-bash">set -Eeuo pipefail
</code></pre>
<p>Explanation:</p>
<pre><code class="language-bash">set -o errtrace      # Functions, substitutions &amp; sub-shells inherit traps
set -o errexit       # Stops script if any command fail
set -o nounset       # Error when using unset variables
set -o pipefail      # Error when a command in a pipeline fails
</code></pre>
<p>The <code>xtrace</code> option is also useful for debugging:</p>
<pre><code class="language-bash">set -x
set -o xtrace        # Print each executed command
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="xml"><a class="header" href="#xml">XML</a></h1>
<h2 id="xpath"><a class="header" href="#xpath">xpath</a></h2>
<p>Find tags ignoring namespaces</p>
<pre><code class="language-py">&quot;//*[local-name()='reservationOriginatorCode']&quot;
</code></pre>
<p>Filter nodes based on a sub-node text, then find a sibling element:</p>
<pre><code class="language-xml">&lt;rf5:ResGuests&gt;
  &lt;ResGuest&gt;
    &lt;reservationID&gt;12345&lt;/reservationID&gt;
    &lt;ReservationReferences&gt;
      &lt;ReservationReference type=&quot;PMSID&quot; legNumber=&quot;1&quot; /&gt;
    &lt;/ReservationReferences&gt;
  &lt;/ResGuest&gt;
&lt;rf5:ResGuests&gt;
</code></pre>
<pre><code class="language-py">leg_numbers = set(
    xml.getroottree().xpath(
        # 1. Get ResGuest corresponding to this reservation
        # 2. Get the Leg Number from that ResGuest
        &quot;&quot;&quot;
        ./rf5:ResGuests/rf5:ResGuest[rf5:reservationID[text()[normalize-space(.)='12345']]]
        //rf5:ReservationReference[@type='PMSID']/@legNumber
        &quot;&quot;&quot;,
        namespaces=NAMESPACES_MAP,
    )
)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="databases"><a class="header" href="#databases">Databases</a></h1>
<ul>
<li>Clustering organises the data on the disk:
<ul>
<li>An example of how this can improve performance: <a href="https://bclennox.com/the-postgres-cluster-command">https://bclennox.com/the-postgres-cluster-command</a></li>
</ul>
</li>
<li>Long Table Names suck:
<ul>
<li>They make queries so much longer</li>
<li>Seriously.</li>
</ul>
</li>
</ul>
<h2 id="uuid-foreign-keys"><a class="header" href="#uuid-foreign-keys">UUID Foreign Keys</a></h2>
<p>I liked the idea.</p>
<p>UUIDs suck:</p>
<ul>
<li>Visually they take up more space (e.g. result of queries)</li>
<li>Harder to just remember the ID in your head when you need to</li>
<li>Lose automatic (basic) ordering of rows</li>
<li>Copying and pasting is much more difficult because double-click to copy does not include the quotes</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sql"><a class="header" href="#sql">SQL</a></h1>
<p><a href="https://pgexercises.com/">https://pgexercises.com/</a></p>
<p><a href="http://tatiyants.com/pev/">http://tatiyants.com/pev/</a> - Explain Visualiser</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Data Description Language (DDL)</th><th style="text-align: left">Data Manipulation Language (DML)</th><th style="text-align: left">Data Control Language (DCL)</th><th style="text-align: left">Transaction Control Language (TCL)</th></tr></thead><tbody>
<tr><td style="text-align: left">CREATE/ALTER/DROP/TRUNCATE/RENAME</td><td style="text-align: left">SELECT/INSERT/UPDATE/DELETE</td><td style="text-align: left">GRANT/REVOKE</td><td style="text-align: left">BEGIN/COMMIT/ROLLBACK/SAVEPOINT</td></tr>
</tbody></table>
</div>
<h2 id="query-summary"><a class="header" href="#query-summary">Query Summary</a></h2>
<p>The key actions are:</p>
<pre><code class="language-SQL">SELECT [DISTINCT] ... FROM ...
UNION
[INNER|LEFT|RIGHT|OUTER] JOIN ... ON ...
WHERE ...
GROUP BY ...
HAVING ...
ORDER BY ... [ASC|DESC]
LIMIT ... OFFSET ...

INSERT INTO ... VALUES ...

UPDATE ... SET ... [WHERE ...]

DELETE ...
</code></pre>
<p><strong>SELECT</strong> can be used with <strong>AS</strong> to rename a table or a column.</p>
<p><strong>UNION</strong> adds the rows of different queries</p>
<p><strong>WHERE</strong> determines which rows will be processed by the query and filters rows before the GROUP BY.</p>
<p><strong>HAVING</strong> comes in at the end of a query after the GROUP BY and determines which rows will be sent to the client. It allows aggregate functions by filtering group rows created by the GROUP BY.</p>
<p><a href="https://sql-bits.com/the-difference-between-where-and-having/">The difference between WHERE and HAVING</a>.</p>
<p>The order is in fact:</p>
<ol>
<li>FROM [UNION/JOIN]</li>
<li>WHERE</li>
<li>GROUP BY</li>
<li>HAVING</li>
<li>SELECT</li>
<li>ORDER BY</li>
<li>LIMIT</li>
</ol>
<blockquote>
<p><code>ORDER BY</code> clause example: <code>ORDER BY x DESC, y NULLS FIRST</code>.</p>
<p><strong>SQL:2008</strong> The <code>LIMIT</code> clause is <code>OFFSET n ROWS FETCH FIRST m ROWS ONLY</code>.</p>
</blockquote>
<h2 id="operations"><a class="header" href="#operations">Operations</a></h2>
<p>We have the arithmetic operators +, -, *, /, and %.</p>
<p>Logical/Comparison operators include:</p>
<pre><code class="language-SQL">IS (NOT) NULL
UNIQUE?
=, &lt;, &gt;
&lt;&gt;, !=
NOT, AND, OR
BETWEEN ... AND ...
EXISTS
IN ...
LIKE ...
... ANY, ALL
</code></pre>
<p><strong>BETWEEN</strong> can be numbers, texts, or dates. In the case of text it seems to use alphabetical ordering (Unicode considerations)?</p>
<p><strong>EXISTS</strong> tests whether a <em>subquery</em> returns any values (boolean existence check).</p>
<p><strong>IN</strong> can use a tuple of values <code>('George', 'Clooney')</code>, or a <em>subquery</em>.</p>
<p><strong>LIKE</strong> uses two wildcards % (0+ characters), and _ (exactly one character). For example, <code>_r%</code> would mean values with &quot;r&quot; in the 2nd position.</p>
<p><strong>ANY</strong> and <strong>ALL</strong> can be used with an operator against a <em>subquery</em>, e.g. <code>WHERE column = ANY (SELECT ...)</code>.</p>
<h2 id="aggregate-functions"><a class="header" href="#aggregate-functions">Aggregate Functions</a></h2>
<p>We have aggregate functions that can act on values:</p>
<pre><code class="language-SQL">MIN
MAX
COUNT
AVG
SUM
</code></pre>
<p>Be aware, that the aggregate selects on the column, and <a href="https://bernardoamc.github.io/sql/2015/05/04/group-by-non-aggregate-columns/">will not select the entire row</a>.</p>
<h2 id="common-table-expressions-ctes"><a class="header" href="#common-table-expressions-ctes">Common Table Expressions (CTEs)</a></h2>
<p>Create composable queries using query-specific views. I call these <code>WITH</code> clauses.</p>
<pre><code class="language-SQL">WITH
    my_view AS (
        SELECT x
        FROM y
    )
    -- Remove invalid things
  , my_filter AS (
        SELECT x
        FROM y
        WHERE x IS NOT NULL
    )

SELECT x
FROM my_filter
;
</code></pre>
<h2 id="correlated-subqueries"><a class="header" href="#correlated-subqueries">Correlated Subqueries</a></h2>
<p>A query nested inside another query that uses values from the outer query.</p>
<p>The subquery is (usually) evaluated once for each outer query row.</p>
<p>In the <code>SELECT</code> clause:</p>
<pre><code class="language-SQL">SELECT
    a
  , (
        SELECT AVG(x2.a)
        FROM x AS x2
        WHERE x2.b = x1.b
    )
FROM x AS x1
</code></pre>
<p>In the <code>WHERE</code> clause:</p>
<pre><code class="language-SQL">SELECT a
FROM x AS x1
WHERE
    a &gt; (
        SELECT AVG(a)
        FROM x AS x2
        WHERE x2.b = x1.b
    )
;
</code></pre>
<h2 id="window-functions"><a class="header" href="#window-functions">Window functions</a></h2>
<p>https://thoughtbot.com/blog/postgres-window-functions</p>
<h2 id="misc"><a class="header" href="#misc">Misc.</a></h2>
<pre><code class="language-SQL">-- comment
/* block comment */
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p><img src="sql/./joins.png" alt="" /></p>
<p><strong>Joins start off as a cross-product</strong>, and predicates (&quot;ON&quot;) filter the rows down.</p>
<ul>
<li><strong>LEFT OUTER JOIN</strong> - always return all rows for A, with anything that happens to match in B (ie. B could be null).</li>
<li><strong>RIGHT OUTER JOIN</strong>s are fairly useless - just do a left join for intuitiveness (possible exception for 3+ tables?).</li>
<li><strong>FULL OUTER JOIN</strong> - either side could be null.</li>
<li><strong>INNER JOIN</strong> - return only rows with matching records on both sides.</li>
</ul>
<h2 id="lateral-joins"><a class="header" href="#lateral-joins">Lateral Joins</a></h2>
<p>A lateral join is like a for-each loop. It can join multiple rows for each original row.</p>
<p>Contrast this with a correlated subquery which can only return one row.</p>
<p>Each lateral join subquery in the <code>FROM</code> clause can reference columns from preceding FROM subqueries. Without the lateral, each subquery is evaluated independently.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="trust-in-your-database"><a class="header" href="#trust-in-your-database">Trust in your database</a></h1>
<p>Excellent article on race conditions:</p>
<p>https://ketanbhatt.com/db-concurrency-defects/</p>
<h2 id="cap"><a class="header" href="#cap">CAP</a></h2>
<p>Choose two: consistency, availability or partition tolerence</p>
<p>Alt: PACELC.</p>
<h2 id="acid"><a class="header" href="#acid">ACID</a></h2>
<p>Traditional RDBMS drop availability</p>
<ul>
<li>Atomicity - transaction is all or nothing</li>
<li>Consistency - database-level rules (e.g. constraints) will always be met</li>
<li>Isolation - differing levels! Essentially nobody else sees your changes until you want them to</li>
<li>Durability - when it says its done you can either nuke the power cable, machine, or data centre</li>
</ul>
<h2 id="base"><a class="header" href="#base">BASE</a></h2>
<p><strong>B</strong>asically <strong>A</strong>vailable, <strong>S</strong>oft state, <strong>E</strong>ventual consistency.</p>
<p>Often chosen by NOSQL databases. Drops consistency.</p>
<p>Durability concerns. Consistency concerns.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="migrations"><a class="header" href="#migrations">Migrations</a></h1>
<p>My talk: <a href="http://qasimk.io/talks/2019/database-migrations-2#1">http://qasimk.io/talks/2019/database-migrations-2#1</a></p>
<p>An excellent article: <a href="https://benchling.engineering/move-fast-and-migrate-things-how-we-automated-migrations-in-postgres-d60aba0fc3d4">https://benchling.engineering/move-fast-and-migrate-things-how-we-automated-migrations-in-postgres-d60aba0fc3d4</a></p>
<h2 id="cliffnotes-for-postgres"><a class="header" href="#cliffnotes-for-postgres">Cliffnotes for Postgres</a></h2>
<ul>
<li>Adding a <code>NOT NULL</code> field , or one with a dynamic default value (NB: &lt; Postgres 11) causes the entire table and its indexes to be rewritten
<ul>
<li>Do multi-step deploy</li>
</ul>
</li>
<li>Adding a new NOT NULL with DEFAULT applies default to all existing rows
<ul>
<li>Add default after column is created applies it to new rows only</li>
</ul>
</li>
<li>Removing a NOT NULL field can cause the ORM to read/write a non-existant field
<ul>
<li>Migrate to NULL before removing code</li>
</ul>
</li>
<li>Creating an index locks the entire table, preventing writes
<ul>
<li>Use CREATE INDEX CONCURRENTLY</li>
</ul>
</li>
<li>Creating constraints (inc. NOT NULL) locks the entire table.
<ul>
<li>Use 2-step creation: ... NOT VALID and VALIDATE CONSTRAINT - NOT VALID uses ACCESS EXCLUSIVE, but VALIDATE only uses SHARE UPDATE EXCLUSIVE and a full table scan.</li>
</ul>
</li>
<li>Most <code>ALTER TABLE</code> operations (including <code>ADD COLUMN</code>, <code>DROP COLUMN</code>) require an <code>ACCESS EXCLUSIVE</code> lock which waits for ALL other queries to complete (including <code>SELECT</code>!)
<ul>
<li>Set a very low <code>lock_timeout</code> and <code>statement_timeout</code> (&lt; 10 seconds) to allow migration to fail without affecting normal operation.</li>
<li>Reduce size of transactions/queries; beware of SQLAlchemy's automatic start of transaction even on a first select.</li>
</ul>
</li>
<li>Default ORM queries select all columns to populate the full object, this is a problem because...</li>
<li>DROP COLUMN hides column, and <em>gradually</em>, as writes occur, replaces it with NULLs to free up space.</li>
</ul>
<h3 id="versions"><a class="header" href="#versions">Versions</a></h3>
<ul>
<li>v11 - you can add a new column with a default without causing a full table re-write</li>
</ul>
<h2 id="automated-checks"><a class="header" href="#automated-checks">Automated Checks</a></h2>
<ul>
<li>Check indexes are created concurrently</li>
<li>Check constraints are created in the background</li>
<li>Check new columns are NULLABLE [[without a default value]]</li>
<li>Check removed columns are NULLABLE</li>
<li>In tests, check queries against a new <code>deprecated_column</code> to ensure they are not being used before removal</li>
<li>Use a <code>renamed_to</code> column-thing to automatically create SQL triggers to populate data bi-directionally</li>
<li>(SQLAlchemy) Check every foreign key is covered by an index</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<title>Migrations</title>
<style>
    [data-pg-versions]::before {
        content: "PostgreSQL versions " attr(data-pg-versions);
        font-weight: bold;
    }

    [data-show] {
        display: initial;
    }

    [data-hide] {
        display: none;
    }

    h2:target {
        background-color: yellow;
    }

    section {
        margin-top: 3em;
    }

    summary {
        cursor: pointer;
    }

    details[open] {
        border: 1px solid black;
    }

    footer {
        margin-top: 3em;
    }

    .good {
        background-color: #AF0;
    }

    .warning {
        background-color: #F99;
    }

    #postgres-version {
        display: none;
    }
</style>
<header>
    <p><a href="sql/migrations.html">â˜š Back to Book</a>
    <h1 id="how-to-avoid-dangerous-database-migrations"><a class="header" href="#how-to-avoid-dangerous-database-migrations">HOW-TO: Avoid Dangerous Database Migrations</a></h1>
    <p>
        <em>For PostgreSQL versions 9.5 - 12</em>
        <select id="postgres-version">
            <option value="all" selected>Show All Versions</option>
            <option value="9.5">PostgreSQL 9.5</option>
            <option value="9.6">PostgreSQL 9.6</option>
            <option value="10">PostgreSQL 10</option>
            <option value="11">PostgreSQL 11</option>
            <option value="12">PostgreSQL 12</option>
        </select>
        <noscript>
            <br><em>Enable JavaScript to select a specific PostgreSQL version</em>
        </noscript>
    <p>
        Database migrations can seem safe on tables with little read and write
        activity.
        <br>
        However, in production the exact same migration can be deadly for busy
        tables.
    <p>
        This is only a HOW-TO guide; a more detailed understanding can be
        obtained from the <a href="sql/migrations-howto.html#references">references</a>.
<pre><code>&lt;p&gt;
    Consult the table of contents before creating an automated migration.

&lt;details&gt;
    &lt;summary&gt;&lt;strong&gt;General Advice...&lt;/strong&gt;&lt;/summary&gt;
    &lt;ol&gt;
        &lt;li&gt;Deployments should do the following things in order:
            &lt;ol&gt;
                &lt;li&gt;Migrate the database successfully
                &lt;li&gt;Then, and only then, deploy the new code
            &lt;/ol&gt;
        &lt;li&gt;Application code should be forwards-compatible with the new schema.
        &lt;li&gt;Database schemas should be backwards-compatible with the old code.
        &lt;li&gt;Use a statement timeout for all automated migrations:
            &lt;br&gt;
            &lt;code&gt;
                SET statement_timeout = &quot;5000&quot;;&lt;br&gt;
            &lt;/code&gt;
        &lt;li&gt;Optionally, additionally, use a lock timeout for all automated migrations:
            &lt;br&gt;
            &lt;code&gt;
                SET lock_timeout = &quot;2000&quot;;&lt;br&gt;
            &lt;/code&gt;
    &lt;/ol&gt;
&lt;/details&gt;
</code></pre>
</header>
<nav>
    <h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
    <p>PostgreSQL HOW-TOs:
    <ol>
        <li>
            <a href="sql/migrations-howto.html#create-null-with-default">
                Create a NULL Column with a DEFAULT
            </a>
        <li>
            <a href="sql/migrations-howto.html#create-not-null">
                Create a NOT NULL Column
            </a>
        <li>
            <a href="sql/migrations-howto.html#make-null-not-null">
                Make a NULL Column NOT NULL
            </a>
        <li>
            <a href="sql/migrations-howto.html#create-index">
                Create an Index
            </a>
        <li>
            <a href="sql/migrations-howto.html#create-constraint">
                Create a Constraint
            </a>
        <li>
            <a href="sql/migrations-howto.html#create-foreign-key">
                Create a Foreign Key
            </a>
    </ol>
    <p>ORM HOW-TOs:
    <ol>
        <li>
            <a href="sql/migrations-howto.html#drop-not-null-column">
                Drop a NOT NULL Column
            </a>
        <li>
            <a href="sql/migrations-howto.html#drop-column">
                Drop a Column
            </a>
        <li>
            <a href="sql/migrations-howto.html#rename-column">
                Rename a Column
            </a>
    </ol>
</nav>
<section>
    <h2 id="create-null-with-default">
        Create a NULL Column with a DEFAULT
    </h2>
    <p>
        <code>
            ALTER TABLE table ADD COLUMN column INT DEFAULT 0;
        </code>
    <p>(Setting a default value after adding the column is different&mdash;it won't apply the default to existing rows.)
    <div data-pg-versions="9.5 9.6 10">
        <p>
        <details>
            <summary><mark class="warning">This is unsafe.</summary>
            <p>This will cause the entire table to be re-written to disk.
        </details>
        <p>Safe alternative:
        <ol>
            <li><code>ALTER TABLE table ADD COLUMN column INT;</code>
            <li>Set the value on existing rows <strong>in batches</strong>:
                <br>
                <code>
                    UPDATE table SET column = 0 WHERE id >= 0 AND id < 1000;
                </code>
    </div>
    <div data-pg-versions="11 12">
        <p>
            <mark class="good">
                Since PostgreSQL 11
                <a href="https://brandur.org/postgres-default">
                    this is safe.
                </a>
            </mark>
    </div>
</section>
<section>
    <h2 id="create-not-null"><a class="header" href="#create-not-null">Create a NOT NULL Column</a></h2>
    <p>
        <code>
            ALTER TABLE table ADD COLUMN column INT DEFAULT 0 NOT NULL;
        </code>
    <p>(A default value is required.)
    <p>This is much better than: NULL âžœ Backfill Default âžœ NOT NULL.
    <p>It is literally better to use an incorrect default value.
<pre><code>&lt;div data-pg-versions=&quot;9.5 9.6 10&quot;&gt;
    &lt;p&gt;
    &lt;details&gt;
        &lt;summary&gt;&lt;mark class=&quot;warning&quot;&gt;This is unsafe.&lt;/summary&gt;
        &lt;p&gt;This will cause the entire table to be re-written to disk.
        &lt;p&gt;An &lt;code&gt;ACCESS_EXCLUSIVE&lt;/code&gt; lock is acquired during this.
        &lt;p&gt;This blocks &lt;strong&gt;all&lt;/strong&gt; queries.
        &lt;p&gt;Alternative: make it NULL first&amp;mdash;still slow because a full table scan is required (faster than a table re-write).
    &lt;/details&gt;
    &lt;p&gt;There is no way to do this without downtime.
&lt;/div&gt;
&lt;div data-pg-versions=&quot;11 12&quot;&gt;
    &lt;p&gt;
        &lt;mark class=&quot;good&quot;&gt;
            Since PostgreSQL 11
            &lt;a href=&quot;https://brandur.org/postgres-default&quot;&gt;
                this is safe.
            &lt;/a&gt;
        &lt;/mark&gt;
&lt;/div&gt;
</code></pre>
</section>
<section>
    <h2 id="make-null-not-null"><a class="header" href="#make-null-not-null">Make a NULL Column NOT NULL</a></h2>
    <p>
        <code>
            ALTER TABLE table ALTER column SET NOT NULL;
        </code>
<pre><code>&lt;div data-pg-versions=&quot;9.5 9.6 10 11&quot;&gt;
    &lt;p&gt;
    &lt;details&gt;
        &lt;summary&gt;&lt;mark class=&quot;warning&quot;&gt;This is unsafe.&lt;/summary&gt;
        &lt;p&gt;This will cause a full table scan.
        &lt;p&gt;An &lt;code&gt;ACCESS_EXCLUSIVE&lt;/code&gt; lock is acquired during this.
        &lt;p&gt;This blocks &lt;strong&gt;all&lt;/strong&gt; queries.
    &lt;/details&gt;
    &lt;p&gt;The closest alternative is to create table constraint instead.
    &lt;p&gt;The downsides are: 0.5-1% performance hit, and the NOT NULL is fairly invisible.
    &lt;ol&gt;
        &lt;li&gt;
            &lt;code&gt;
                SET statement_timeout = &quot;3000&quot;;&lt;br&gt;
                SET lock_timeout = &quot;3000&quot;;&lt;br&gt;
                ALTER TABLE table
                ADD CONSTRAINT ck_constraint_name
                CHECK (column IS NOT NULL)
                NOT VALID;
            &lt;/code&gt;
        &lt;li&gt;
            &lt;code&gt;
                SET statement_timeout = &quot;0&quot;;&lt;br&gt;
                SET lock_timeout = &quot;0&quot;;&lt;br&gt;
                VALIDATE CONSTRAINT ck_constraint_name;
            &lt;/code&gt;
    &lt;/ol&gt;

    &lt;p&gt;&lt;small&gt;&lt;mark&gt;Upgrading to PostgreSQL 12 allows the suboptimal constraint to be replaced.&lt;/mark&gt;&lt;/small&gt;
&lt;/div&gt;
&lt;div data-pg-versions=&quot;12&quot;&gt;
    &lt;p&gt;
    &lt;details&gt;
        &lt;summary&gt;&lt;mark class=&quot;warning&quot;&gt;This is unsafe.&lt;/summary&gt;
        &lt;p&gt;An &lt;code&gt;ACCESS_EXCLUSIVE&lt;/code&gt; lock is acquired during this.
        &lt;p&gt;This blocks &lt;strong&gt;all&lt;/strong&gt; queries.
        &lt;p&gt;A full table scan is required which takes a &lt;em&gt;long&lt;/em&gt; time.
    &lt;/details&gt;
    &lt;p&gt;Since PostgreSQL 12 it is possible to use an existing constraint to help.
    &lt;p&gt;Safe alternative:
    &lt;ol&gt;
        &lt;li&gt;
            &lt;code&gt;
                SET statement_timeout = &quot;3000&quot;;&lt;br&gt;
                SET lock_timeout = &quot;3000&quot;;&lt;br&gt;
                ALTER TABLE table
                ADD CONSTRAINT ck_constraint_name
                CHECK (column IS NOT NULL)
                NOT VALID;
            &lt;/code&gt;
        &lt;li&gt;
            &lt;code&gt;
                SET statement_timeout = &quot;0&quot;;&lt;br&gt;
                SET lock_timeout = &quot;0&quot;;&lt;br&gt;
                VALIDATE CONSTRAINT ck_constraint_name;
            &lt;/code&gt;
        &lt;li&gt;
            &lt;code&gt;
                ALTER TABLE table ALTER column SET NOT NULL;
            &lt;/code&gt;
        &lt;li&gt;
            &lt;code&gt;
                SET statement_timeout = &quot;3000&quot;;&lt;br&gt;
                SET lock_timeout = &quot;3000&quot;;&lt;br&gt;
                ALTER TABLE table DROP CONSTRAINT ck_constraint_name;
            &lt;/code&gt;
&lt;/div&gt;
</code></pre>
</section>
<section>
    <h2 id="Create-index"><a class="header" href="#Create-index">Create an Index</a></h2>
    <p>
        <code>
            CREATE INDEX name_idx ON table (column);
        </code>
    <p>
        <code>
            CREATE UNIQUE INDEX name_idx ON table (column);
        </code>
<pre><code>&lt;div data-pg-versions=&quot;9.5 9.6 10 11 12&quot;&gt;
    &lt;p&gt;
        &lt;details&gt;
            &lt;summary&gt;&lt;mark class=&quot;warning&quot;&gt;This is unsafe.&lt;/summary&gt;
            &lt;p&gt;A &lt;code&gt;SHARE&lt;/code&gt; lock is acquired for this operation.
            &lt;p&gt;This blocks &lt;strong&gt;writes&lt;/strong&gt; on the table.
            &lt;p&gt;A full table scan is required which takes a &lt;em&gt;long&lt;/em&gt; time.
        &lt;/details&gt;
    &lt;p&gt;A good alternative is to create the index concurrently.
    &lt;p&gt;The downside is that more total work is performed and it takes longer overall.
    &lt;p&gt;There are other caveats in the PostgreSQL documentation, but I feel they are unlikely to be a problem.
    &lt;ol&gt;
        &lt;li&gt;
            &lt;code&gt;
                SET statement_timeout = &quot;0&quot;;&lt;br&gt;
                SET lock_timeout = &quot;0&quot;;&lt;br&gt;
                CREATE INDEX CONCURRENTLY name_idx ON table (column);
            &lt;/code&gt;
        &lt;li&gt;Check the index was created successfully:
            &lt;br&gt;
            &lt;code&gt;
                \d table
            &lt;/code&gt;
            &lt;br&gt;
            Invalid indexes are marked with &lt;code&gt;INVALID&lt;/code&gt;.
        &lt;li&gt;If it was unsuccessful, try again after dropping the index:
            &lt;br&gt;
            &lt;code&gt;
                DROP INDEX name_idx;
            &lt;/code&gt;
    &lt;/ol&gt;
&lt;/div&gt;
</code></pre>
</section>
<section>
    <h2 id="create-constraint"><a class="header" href="#create-constraint">Create a Constraint</a></h2>
    <p>NOT VALID, then VALIDATE CONSTRAINT
    <p>Not tried.
</section>
<section>
    <h2 id="create-foreign-key"><a class="header" href="#create-foreign-key">Create a Foreign Key</a></h2>
    <p>Not tried.
    <p>Requires lock on foreign key target.
</section>
<section>
    <h2 id="drop-not-null-column"><a class="header" href="#drop-not-null-column">Drop a NOT NULL Column</a></h2>
    <p>Problem with ORM reading and writing field.
    <p>Safe alternative: make null first, then follow drop a column.
</section>
<section>
    <h2 id="drop-column"><a class="header" href="#drop-column">Drop a Column</a></h2>
    <p>Problem with ORM reading and writing field(?)
    <p>Problem with ACCESS EXCLUSIVE lock (waiting issue)
</section>
<section>
    <h2 id="rename-column"><a class="header" href="#rename-column">Rename a Column</a></h2>
    <p>...
</section>
<footer>
    <h2 id="references"><a class="header" href="#references">References</a></h2>
    <ul>
        <li>
            <a href="https://www.postgresql.org/docs/current/index.html">
                The PostgreSQL manual
            </a>
        <li>Old (2015):
            <a href="https://gocardless.com/blog/zero-downtime-postgres-migrations-the-hard-parts/">
                https://gocardless.com/blog/zero-downtime-postgres-migrations-the-hard-parts/
            </a>
        <li>Old (2014): <a href="https://www.braintreepayments.com/blog/safe-operations-for-high-volume-postgresql/">https://www.braintreepayments.com/blog/safe-operations-for-high-volume-postgresql/</a>
    </ul>
<script>
    const postgresVersionElement = document.getElementById("postgres-version");
    postgresVersionElement.addEventListener("change", handleVersionChange);

    function handleVersionChange() {
        const postgresVersion = postgresVersionElement.value;
        if (postgresVersion === "all") {
            showAllVersions();
        } else {
            showVersion(postgresVersion);
        }
    };

    function showVersion(version) {
        const toShow = document.querySelectorAll(
            `[data-pg-versions~="${version}"]`
        );
        const toHide = document.querySelectorAll(
            `[data-pg-versions]:not([data-pg-versions~="${version}"])`
        );

        toShow.forEach(element => element.style.display = "initial");
        toHide.forEach(element => element.style.display = "none");
    };

    function showAllVersions() {
        const toShow = document.querySelectorAll("[data-pg-versions]");
        toShow.forEach(element => element.style.display = "initial");
    };

    // Init
    handleVersionChange();
    postgresVersionElement.style.display = "initial";
</script>
<div style="break-before: page; page-break-before: always;"></div><h1 id="postgres-specific-features"><a class="header" href="#postgres-specific-features">Postgres-specific features</a></h1>
<h2 id="shell"><a class="header" href="#shell">Shell</a></h2>
<p>Use <code>pgcli</code> with <code>pipx install pgcli</code> because it offers syntax highlighting and auto-completion.</p>
<h2 id="watch"><a class="header" href="#watch">Watch</a></h2>
<p>Execute a query then type <code>\watch</code>.</p>
<h2 id="wide-tables"><a class="header" href="#wide-tables">Wide tables</a></h2>
<p>Display tables vertically <code>\x auto</code>.</p>
<h2 id="time-queries"><a class="header" href="#time-queries">Time queries</a></h2>
<p>Activate before executing <code>\timing on</code>.</p>
<h2 id="get-cell-as-file"><a class="header" href="#get-cell-as-file">Get cell as file</a></h2>
<p>Use <code>With CSV</code> for CSV files.</p>
<pre><code class="language-psql">\copy (Select * From foo) To 'test.csv' With BINARY;
</code></pre>
<p>XMLs, manually remove <code>|</code> from the front and end of the file:</p>
<pre><code>\copy (SELECT xml_field FROM table_name) TO 'output.xml' WITH CSV QUOTE AS '|';
</code></pre>
<h2 id="disk-space"><a class="header" href="#disk-space">Disk Space</a></h2>
<p>Free up disk space:</p>
<pre><code class="language-terminal">vacuumdb --all --full --freeze
</code></pre>
<p>List total table sizes (including indexes):</p>
<pre><code class="language-sql">SELECT nspname || '.' || relname AS &quot;relation&quot;,
    pg_size_pretty(pg_total_relation_size(C.oid)) AS &quot;total_size&quot;
  FROM pg_class C
  LEFT JOIN pg_namespace N ON (N.oid = C.relnamespace)
  WHERE nspname NOT IN ('pg_catalog', 'information_schema')
    AND C.relkind &lt;&gt; 'i'
    AND nspname !~ '^pg_toast'
  ORDER BY pg_total_relation_size(C.oid) DESC
  LIMIT 20;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-overviewdevelopment"><a class="header" href="#linux-overviewdevelopment">Linux Overview/Development</a></h1>
<ul>
<li>The <a href="https://www.freedesktop.org/software/systemd/man/file-hierarchy.html">filesystem hierarchy</a></li>
<li>The <a href="https://zwischenzugs.com/2018/06/08/anatomy-of-a-linux-dns-lookup-part-i/">linux DNS lookup</a></li>
<li><a href="https://tldr.ostera.io/">tl;dr</a> how-to guide to commands
<ul>
<li>Alt: <a href="http://bropages.org/">bropages</a></li>
<li>Alt: <a href="https://github.com/chrisallenlane/cheat">cheat</a></li>
<li>Alt: <a href="https://github.com/knqyf263/pet/">pet</a></li>
</ul>
</li>
<li><a href="https://github.com/nvbn/thefuck">thefuck</a> corrects your previous console command</li>
<li>How to control the <a href="https://wiki.archlinux.org/index.php/XDG_Base_Directory_support">proliferation of dotfiles</a></li>
<li>(A way-too-big list of tools to make an <a href="https://github.com/alebcay/awesome-shell">awesome shell</a>.)</li>
<li><a href="https://access.redhat.com/sites/default/files/attachments/rh_ip_command_cheatsheet_1214_jcs_print.pdf">ip cheat sheat</a> (pdf)</li>
<li>A check list of <a href="https://github.com/jlevy/the-art-of-command-line">things to know about the command line</a></li>
</ul>
<h2 id="development"><a class="header" href="#development">Development</a></h2>
<ul>
<li><a href="https://direnv.net/">direnv</a> - manage environment variables per-project</li>
<li><a href="https://fishshell.com/">fish</a>/<a href="http://xiki.org/">xiki</a> - alternative shells</li>
<li><a href="https://github.com/tmux/tmux">tmux</a> - remote window management - <a href="https://gist.github.com/MohamedAlaa/2961058">cheatsheat</a></li>
<li><a href="https://github.com/samwho/spacer">spacer</a> - put spaces between command output</li>
</ul>
<h3 id="packaging"><a class="header" href="#packaging">Packaging</a></h3>
<p>If you ever want to package something for Linux, <a href="https://repology.org/">Repology</a> covers where.</p>
<h2 id="web-tools"><a class="header" href="#web-tools">Web Tools</a></h2>
<ul>
<li><a href="https://crontab.guru/">crobtab.guru</a> - write cron schedules</li>
<li><a href="https://explainshell.com/">explainshell</a> - explain (long) shell commands</li>
</ul>
<h2 id="shell-1"><a class="header" href="#shell-1">Shell</a></h2>
<ul>
<li>Consider an alias like <code>alias q=&quot;ls | grep --color -i&quot;</code>.</li>
<li>The <code>history</code> command (<code>history search</code>).</li>
<li>Process management: &amp; fg bg jobs kill disown nohup (CTRL+C/Z).</li>
<li><code>kill -SIGSTOP</code> and <code>kill -SIGCONT</code> for pause/resume.</li>
<li><code>pgrep</code> to search for PID by name.</li>
<li><code>script</code> to record shell session in file (and <code>cat</code> or  <code>less -R</code> to view).</li>
<li>From <code>less</code> to edit, press <code>v</code>.</li>
<li>Use <code>type -a</code> not <code>which</code> as the <a href="https://old.reddit.com/r/archlinux/comments/de1er6/arch_linux_news_base_group_replaced_by_mandatory/f2ynnho/">latter is problematic</a></li>
</ul>
<h3 id="alternative-tools"><a class="header" href="#alternative-tools">Alternative Tools</a></h3>
<ul>
<li>ncdu (du -smh, df -l)</li>
<li><a href="https://github.com/jarun/nnn">nnn</a> - Terminal File Browser</li>
</ul>
<h2 id="makefiles"><a class="header" href="#makefiles">Makefiles</a></h2>
<p>I advise <a href="linux/thoughts/avoid-makefiles.html">avoiding makefiles to run scripts</a>.</p>
<p>Template:</p>
<pre><code class="language-makefile">MAKEFLAGS += --warn-undefined-variables
MAKEFLAGS += --no-builtin-rules

##     help:   This.
.PHONY: help
.DEFAULT: help
help: Makefile
#       Find all double comments and treat them as docstrings
        @echo &quot;make &lt;command&gt;&quot;
        @sed -n 's/^##//p' $&lt;

##     watch:  Hot-reload web-app server.
.PHONY: watch
watch:
#       Build files in case they changed while we were not watching
        $(MAKE) build
        watchman-make -p '*.py' 'Makefile' 'Dockerfile.web' '.dockerignore' -t build


##
##Run make with VERBOSE=1 for additional output.
$(VERBOSE).SILENT:
# Delete targets on failure
.DELETE_ON_ERROR:
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="systemd-files"><a class="header" href="#systemd-files">Systemd Files</a></h1>
<blockquote>
<p>&quot;The only thing more complicated and confusing than systemd is the planet's ecosystem.&quot; - Me</p>
</blockquote>
<p>This page is currently useless.</p>
<p>For example, create <code>/etc/systemd/system/my-ssh-monitor.service</code></p>
<pre><code class="language-ini">[Unit]
description=My SSH monitor
Requires=network-online.target
Wants=sshd.service

[Service]
User=..
Group=..
WorkingDirectory=/home/my-app/
ExecStart=/bin/my-monitor
ExecStop=/bin/kill -HUP $MAINPID
PrivateTmp=true

[Install]
WantedBy=default.target
</code></pre>
<p>systemctl daemon-reload to activate the unit file.</p>
<p>sudo systemctl start|stop|reload|restart|reload-or-restart|enable|disable|status|is-failed</p>
<h2 id="types-of-services"><a class="header" href="#types-of-services">Types of Services</a></h2>
<p>Type=simple - default, must not fork, considered to started immediately.</p>
<h2 id="targets"><a class="header" href="#targets">Targets</a></h2>
<p>What do they do they do?</p>
<p>default.target</p>
<p>network-online.target</p>
<p>multi-user.target</p>
<h2 id="timers"><a class="header" href="#timers">Timers</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shells"><a class="header" href="#shells">Shells</a></h1>
<p>There <a href="https://unix.stackexchange.com/a/4132">difference between a shell, terminal, console and command line</a>.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Fish</th><th style="text-align: left">Bash</th></tr></thead><tbody>
<tr><td style="text-align: left">Alt-L : ls</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: left">Alt-P : append &quot;| less&quot;</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: left">Alt-V : edit command in editor</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: left">Alt-W : what is the current command?</td><td style="text-align: left"></td></tr>
<tr><td style="text-align: left">history</td><td style="text-align: left">history</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="ssh"><a class="header" href="#ssh">SSH</a></h1>
<p>Escape sequences</p>
<ul>
<li><code>&lt;Enter&gt; ~.</code> - terminate connection (and any multiplexed sessions)</li>
<li><code>&lt;Enter&gt; ~C</code> - open command console</li>
<li><code>&lt;Enter&gt; ~?</code> - help message</li>
</ul>
<h2 id="managing-keys"><a class="header" href="#managing-keys">Managing Keys</a></h2>
<p><a href="https://wiki.archlinux.org/index.php/SSH_keys" title="Arch Linux Wiki">The full reference</a> (Arch Wiki).</p>
<p>Common commands:</p>
<pre><code># Create new secure key with comment (User@Device#Realm)
ssh-keygen -t ed25519 -C Qasim@PC#QasimK

# Change passphrase of existing key
ssh-keygen -f ~/.ssh/id_ed25519 -p

# Add your credentials to remote server to allow you to login
ssh-copy-id -i ~/.ssh/id_ed25519.pub &lt;host&gt;
</code></pre>
<p><code>ssh-copy-id</code> adds your SSH key to the remote user's <code>authorized_keys</code> file.</p>
<h2 id="port-forwarding-tcp-only"><a class="header" href="#port-forwarding-tcp-only">Port Forwarding (TCP-only)</a></h2>
<p>Requests to a local port are sent to a remote host/port:</p>
<ul>
<li>The default <code>bind</code> address is <code>localhost</code>.</li>
<li><code>host</code> can be <code>localhost</code> which means <code>sshserver</code> or a remote host.</li>
</ul>
<p><img src="linux/./ssh-local-forward.png" alt="" title="SSH Local Forwarding Diagram" /></p>
<p>Requests to a remote port are sent to a &quot;local&quot; port:</p>
<ul>
<li>The default <code>bind</code> address is <code>localhost</code> on <code>sshserver</code>.
(Changing this requires <code>GatewayPorts</code> in <code>sshd_config</code>.)</li>
<li>The &quot;local&quot; port can be on your device or another <code>host</code>.</li>
</ul>
<p><img src="linux/./ssh-remote-forward.png" alt="" title="SSH Local Forwarding Diagram" /></p>
<p>To cancel port forwarding:</p>
<ol>
<li>In a multiplexed session, run <code>ssh -O cancel &lt;port forward command&gt; &lt;host&gt;</code>.</li>
<li>Otherwise enter the control console and type <code>-KL &lt;port forward command&gt;</code>
(or <code>-KR</code> or <code>-KD</code>).</li>
</ol>
<h2 id="autossh"><a class="header" href="#autossh">Autossh</a></h2>
<p><a href="https://github.com/halida/autossh">autossh</a> can restart an SSH command.</p>
<p>Recommendation: use <code>-M0</code> with <code>ServerAliveInterval</code> and <code>ServerAliveCountMax</code>.</p>
<h2 id="sshd"><a class="header" href="#sshd">SSHD</a></h2>
<p>Test config with <code>sudo sshd -T</code> before restarting the daemon.</p>
<p>The following settings are ordered starting from the most significant, least invasive and easiest to setup:</p>
<ul>
<li>Prevent root login</li>
<li>Use SSH keys only</li>
<li>Use a less common port, e.g. 24</li>
<li>Only allow particular groups/users to login (such as <code>wheel</code>, the administrative group)</li>
</ul>
<pre><code>PermitRootLogin no
PasswordAuthentication no
Port 23
AllowGroups wheel
AllowUsers qasim
</code></pre>
<ul>
<li>Rate-limit attempts: <code>sudo ufw limit OpenSSH</code>  (NB: check auto correct port?)</li>
<li>Use <code>ssh-geoip</code> (blacklist IPs rather than whitelist to prevent lockout) (not tested; IPv6?)</li>
<li>Use an <a href="https://blog.scottlowe.org/2016/09/13/ssh-bastion-host-follow-up/">SSH bastion</a>.</li>
<li>Use fail2ban (not needed with SSH keys; lockout risk)</li>
<li><a href="http://www.justgohome.co.uk/blog/2013/07/better-two-factor-ssh-authentication-on-ubuntu.html">Require 2FA</a>: <code>libpam-google-authenticator</code> (longer setup; not tested; has backup codes)</li>
</ul>
<h2 id="mosh"><a class="header" href="#mosh">Mosh</a></h2>
<ul>
<li>Mosh uses SSH for initial authentication.</li>
<li>Requires UDP ports 60000â€“61000 to be open (you can get away with 60000-60010).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="containers"><a class="header" href="#containers">Containers</a></h1>
<ol>
<li>Programming-level, e.g. Python's Virtualenv</li>
<li>Kernel-level
<ol>
<li>Application encapsulating:, e.g.Docker (ephemeral, separate storage)</li>
<li>OS encapsulating, e.g. LXC, LXD, and kind-of chroot (UNIX)</li>
</ol>
</li>
<li>Hardware virtualisation
<ol>
<li>Heavyweight OS (Type 2 hosted hypervisor), e.g. Vagrant (depending on back-end), Virtualbox</li>
<li>(Type 1 bare metal) Hypervisor, e.g. KVM, Hyper-V</li>
</ol>
</li>
</ol>
<p>Docker, LXC, LXD (uses LXC) all use, on Linux, Linux cgroups and namespaces(net, user, pid, ipc, cgroup).</p>
<p>Kubernetes can be used for orchestration.</p>
<p>You also have things like Firejail, Snap/Flatpak, and AppImage.</p>
<p>Containers may conflate:</p>
<ul>
<li>Security via isolation</li>
<li>Packaging dependencies</li>
<li>Efficient resource utilisation</li>
</ul>
<h2 id="developing-with-vagrant"><a class="header" href="#developing-with-vagrant">Developing with Vagrant</a></h2>
<blockquote>
<p>Consider LXD as a lightweight, non-portable alternative.</p>
</blockquote>
<p>This is useful if you are working on conflicting projects, or want to keep your computer tidy. Keep your setup on your host (text editor and IDE appliations and their config files), and run the project (any executables) within the container. A shared folder can be used to store the repository.</p>
<p>Vagrant is easy if you use the default Virtualbox provider. And, apparently, impossible with vagrant-lxc :/</p>
<p>Plugins (they have been a disaster for me):</p>
<ul>
<li><a href="https://github.com/dotless-de/vagrant-vbguest">vagrant-vbguest</a> to keep VirtualBox's Guest Additions up-to-date on the Vagrant box <em>that started failing</em></li>
<li><a href="https://github.com/mhallin/vagrant-notify-forwarder/">vagrant-notify-forwarder</a> for filesystem event forwarding <em>that is</em> <em>not reliable</em></li>
<li><a href="https://github.com/sprotheroe/vagrant-disksize/">vagrant-disksize</a> to easily increase the size of your Virtualbox disk
<ul>
<li><code>config.disksize.size = '20GB'</code></li>
</ul>
</li>
<li><a href="https://www.vagrantup.com/docs/share/">vagrant-share</a> to be able to share your container with others <em>that I've never used</em></li>
<li><a href="https://github.com/fgrehm/vagrant-lxc/">vagrant-lxc</a> for LXC boxes <em>that don't work</em></li>
</ul>
<p>Create a <a href="https://www.vagrantup.com/docs/vagrantfile/">merging custom Vagrantfile</a> in <code>~/vagrant.d/</code>.</p>
<p>Many applications inside the virtual machine will bind to <code>localhost</code> making them difficult to connect to from the host. We can configure a SOCKS5 proxy with SSH, and use a new profile of Firefox which always connect via that proxy.</p>
<pre><code class="language-ruby">config.vm.network &quot;private_network&quot;, ip: &quot;172.16.3.2&quot;
config.ssh.extra_args = [&quot;-D&quot;, &quot;1632&quot;]
</code></pre>
<p>Using the Firefox extension <a href="https://addons.mozilla.org/en-GB/firefox/addon/smartproxy/">SmartProxy</a>, add the SOCKSv5 Proxy Server (Vagrant; SOCKS5; 127.0.0.1; 1632). Then when browsing to a particular <code>localhost:&lt;port&gt;</code>, click on the toolbar icon and enable &quot;Enable proxy on <code>localhost:&lt;port&gt;</code>&quot;.</p>
<p>It is also possible to connect the VM's shared private network directly on <code>172.16.3.2</code>.</p>
<p>This is easier than forwarding each individual application (which you may not know in advance) with:</p>
<pre><code class="language-ruby">config.vm.network &quot;forwarded_port&quot;, guest: 8000, host: 8000, host_ip: &quot;127.0.0.1&quot;
</code></pre>
<p><strong>Issue with vagrant-vbguest</strong></p>
<pre><code>  if Vagrant.has_plugin?(&quot;vagrant-vbguest&quot;)
    config.vbguest.auto_update = false
  end
</code></pre>
<p><strong>Issue with Kubectl</strong></p>
<p>If you encounter an issue with double port-forwarding (i.e. a port-forward inside the guest and then using Vagrant's port-forward to forward it to your host): <a href="https://stackoverflow.com/questions/49940964/windows-host-vagrant-kubectl-port-forward-stuck-inside-vagrant">https://stackoverflow.com/questions/49940964/windows-host-vagrant-kubectl-port-forward-stuck-inside-vagrant</a>. TODO: I have no idea what that is doing ATM.</p>
<blockquote>
<p># Port Forward from local port 8000 to remote port 80, listening on all addresses so that Vagrant's port forwarding works.</p>
<p>kubectl port-forward --address 0.0.0.0 8000:80</p>
</blockquote>
<h2 id="deploying-with-docker"><a class="header" href="#deploying-with-docker">Deploying with Docker</a></h2>
<ul>
<li>Use <a href="https://github.com/krallin/tini">tini</a> for your applications to handle signals (<a href="https://hynek.me/articles/docker-signals/">article</a>).</li>
<li>Set <code>ENV PYTHONUNBUFFERED 1</code> to ensure all logs are always forwarded.</li>
<li>Compile the Python files <code>python -m compileall .</code>.</li>
<li>Use <a href="https://gist.github.com/QasimK/6f28a8a7ace4fdd0a23e90a652b6c6d8">multi-stage builds</a> for very large Python projects.</li>
</ul>
<p>Recommended: <a href="https://pythonspeed.com/docker/">https://pythonspeed.com/docker/</a></p>
<p><a href="https://blog.realkinetic.com/building-minimal-docker-containers-for-python-applications-37d0272c52f3">https://blog.realkinetic.com/building-minimal-docker-containers-for-python-applications-37d0272c52f3</a></p>
<p><a href="https://cloud.google.com/solutions/best-practices-for-building-containers">https://cloud.google.com/solutions/best-practices-for-building-containers</a></p>
<p><a href="https://cloud.google.com/solutions/best-practices-for-operating-containers">https://cloud.google.com/solutions/best-practices-for-operating-containers</a></p>
<h3 id="best-practises"><a class="header" href="#best-practises">Best Practises</a></h3>
<ul>
<li>Use <a href="https://github.com/hadolint/hadolint">hadolint</a>, a docker file linter</li>
<li>Use <a href="https://github.com/krallin/tini">tini</a> as the correct <code>init</code> (forwards signals and reaps zombies) (<a href="https://hynek.me/articles/docker-signals/">article</a>)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="terminal-pro"><a class="header" href="#terminal-pro">Terminal Pro</a></h1>
<h2 id="nnn"><a class="header" href="#nnn">NNN</a></h2>
<p>The terminal file manager</p>
<h2 id="xdg-mime"><a class="header" href="#xdg-mime">XDG-Mime</a></h2>
<p>Default applications.</p>
<pre><code class="language-console">$ xdg-mime query filetype myfile.md

xdg-mime query default text/plain
text/plain
$ ls /usr/share/applications
... org.gnome.gedit.desktop ...
$ xdg-mime default org.gnome.gedit.desktop text/plain
$ xdg-mime query default text/plain
org.gnome.gedit.desktop
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>Two good resources</p>
<ol>
<li>
<p>High level overview: https://martin.kleppmann.com/2011/03/07/accounting-for-computer-scientists.html</p>
</li>
<li>
<p>https://beancount.github.io/docs/the_double_entry_counting_method.html</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="audio"><a class="header" href="#audio">Audio</a></h1>
<p>https://xiph.org/</p>
<p>Generally don't re-encode the audio with a different codec unless you are using the original lossless.</p>
<h2 id="quality"><a class="header" href="#quality">Quality</a></h2>
<p>Ogg is a container format for Vorbis and Opus codecs.</p>
<ul>
<li>Vorbis is deprecated. Opus generally beats it.</li>
<li>Opus is low-latency, switches between speech and music, very good and low bitrates.</li>
</ul>
<p>See comparison: https://opus-codec.org/comparison/</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ffmpeg"><a class="header" href="#ffmpeg">FFMPEG</a></h1>
<p>Downcode to x264 1080p (copy audio and subtitles)</p>
<pre><code class="language-terminal">ffmpeg -i input.wmv \
       -c:v libx264 -preset veryslow -tune film -crf 22 -vf scale=-2:1080 \
       -c:a copy -c:s copy \
       output.mp4
</code></pre>
<p>Transcode audio: <code>-c:a libfdk_aac -b:a 128k</code></p>
<p>-tune parameter: <a href="https://superuser.com/a/564404/229283">https://superuser.com/a/564404/229283</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="principles"><a class="header" href="#principles">Principles</a></h1>
<p>These guiding principles reduce bugs and increase implementation speed of new features or modifications.</p>
<p>Remember the scope and context of the project. Is it a script? Is it huge? Is it one-off? Is it mission-critical?</p>
<h2 id="yagnikiss"><a class="header" href="#yagnikiss">YAGNI/KISS</a></h2>
<p><em>You aren't gonna need it</em>/<em>keep it simple stupid</em> tells you <em>when</em> to do something. The other principles tell you <em>how</em> to do something.</p>
<h2 id="solid"><a class="header" href="#solid">SOLID</a></h2>
<p><a href="https://wayback.archive.org/web/20170204020312/https://lostechies.com/derickbailey/2009/02/11/solid-development-principles-in-motivational-pictures/">SOLID</a> applies to object-orientated programming.</p>
<ul>
<li>Single Responsibility Principle
<ul>
<li>Domain-dependent</li>
<li>Think about who - the role - that will be causing what changes and isolate that code together</li>
<li>Higher cohesion (object has greater focus)</li>
<li>Lower coupling (object does not connect to or require knowledge of other object)</li>
</ul>
</li>
<li>Open/Closed Principle
<ul>
<li>&quot;An object should be open for extension, but closed for modification&quot;</li>
<li>This means the design should facilitate new functionality or changes in requirements without modifying existing code</li>
<li>The object becoming closed means it now has a well-defined interface and may be used by others</li>
<li>This limits the risk of introducing bugs into already developed &amp; tested code</li>
<li>In a dynamic language it also means you don't dynamically reach into and modify an object</li>
<li>Violation smells: switch/if-else statements that can be extended</li>
<li>Implementation notes: use abstraction and interfaces</li>
<li>Be aware: Pure inheritance introduces coupling if subclasses depend on implementation details of their parent class.</li>
<li>When to use: You cannot predict the future so &quot;modifications may be done once, maybe twice, but not thrice before I used OCP&quot;</li>
</ul>
</li>
<li>Liskov Substitution Principle
<ul>
<li>&quot;A <em>type</em> may be replaced by its <em>sub-types</em> without causing any harm to the program&quot;</li>
<li>Otherwise <a href="https://softwareengineering.stackexchange.com/questions/170222/what-can-go-wrong-if-the-liskov-substitution-principle-is-violated">your method must alter its behaviour</a> by investigating the type of object it has been given</li>
<li>It <a href="https://stefanroock.wordpress.com/2010/11/08/the-liskov-substitution-principle-lsp-in-duck-typed-programming-languages/">works slightly differently in dynamic languages</a>.</li>
</ul>
</li>
<li>Interface Segregation Principle
<ul>
<li>???</li>
</ul>
</li>
<li>Dependency Inversion Principle
<ul>
<li>???</li>
</ul>
</li>
</ul>
<h2 id="composition-over-inheritance"><a class="header" href="#composition-over-inheritance">Composition over Inheritance</a></h2>
<p>Starting point: <a href="https://www.youtube.com/watch?v=3MNVP9-hglc">https://www.youtube.com/watch?v=3MNVP9-hglc</a></p>
<p>Inheritance is difficult with Liskov's substitution principle anyway.</p>
<h2 id="law-of-demeter"><a class="header" href="#law-of-demeter">Law of Demeter</a></h2>
<p>The <em>principle of least knowledge</em>, in particular for OOD, says to loosely couple the design by having objects only talk to their immediate &quot;friends&quot;.</p>
<p>Code Smell: <code>self.friend.internal_variable.dobla()</code></p>
<p>Better: <code>self.friend.dobla()</code></p>
<h2 id="tech-debt"><a class="header" href="#tech-debt">Tech Debt</a></h2>
<p>TBD: <a href="https://engineering.riotgames.com/news/taxonomy-tech-debt">https://engineering.riotgames.com/news/taxonomy-tech-debt</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design-patterns"><a class="header" href="#design-patterns">Design Patterns</a></h1>
<p>Design patterns are boilerplate that is indicative of missing language features. They are useful for communicating with peers.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="anti-patterns"><a class="header" href="#anti-patterns">Anti-patterns</a></h1>
<h2 id="the-lava-layer"><a class="header" href="#the-lava-layer">The Lava Layer</a></h2>
<p>The <a href="https://mikehadlow.blogspot.co.uk/2014/12/the-lava-layer-anti-pattern.html">lava layer</a> is the mismash that results from an evolving codebase that lacks singular vision and continuity of development.</p>
<h2 id="testing-anti-patterns"><a class="header" href="#testing-anti-patterns">Testing anti-patterns</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing"><a class="header" href="#testing">Testing</a></h1>
<blockquote>
<p>I am not happy with this page right now.</p>
</blockquote>
<p>There are many different names and people use different names to mean different
things. The following will likely not confirm to what you think:</p>
<p>Tests can be divided by size:</p>
<ul>
<li>unit-tests - tiny, no IO, no other components involved (small) - fast</li>
<li>integration tests - test combined units (medium-large) - slow</li>
<li>system tests - test multiple high-level stages (large) - slow</li>
</ul>
<p>They can be divided by methodology:</p>
<ul>
<li>functional tests - functional programming, test output based on input (NB: also used to refer to testing features)</li>
<li>acceptance tests - the final end result (black-box) tested at the highest, outer-most level (e.g. using your web app with a web browser)</li>
</ul>
<p>They can be divided by purpose:</p>
<ul>
<li>smoke tests - a subset of tests that quickly reveal severe failures</li>
<li>regression tests - tests that catch bugs that come back, or features that stop working</li>
</ul>
<p>They can be divided by who is doing them:</p>
<ul>
<li>end-to-end tests - performed by QA involving multiple distinct steps to accomplish a goal</li>
<li>user acceptance tests - performed by non-technical business users or otherwise domain-experts to test whether they accept the software in their heart</li>
</ul>
<p>Tests accomplish two main goals:</p>
<ul>
<li>What you've written now is right, including incorporating business requirement directly as a test.</li>
<li>What you've written stays right, including refactoring with confidence (increase development speed; reduce regressions). It leaves a bad impression (on clients) if a bug keeps reappearing, and demoralises developers.</li>
</ul>
<p>Software Quality Assurance (SQA) looks at the development process itself to reduce the number of issues.</p>
<p>You also have operation acceptance tests, which test things like failover, backups, recoveries, performance, monitoring, and alerting.</p>
<h2 id="principles-1"><a class="header" href="#principles-1">Principles</a></h2>
<ul>
<li>The tests can help guide you towards a nice API, e.g. write the final candidate API with its integration tests and write the lower level details to advance the integration test as needed with unit-tests alongside it. i.e. Write what a thing is supposed to do</li>
<li>Found a bug? Write a test that verifies it, then fix it. (Usually.)</li>
<li>Arrange-Act-Assert (AAA): set up the test, execute your code, check against expected results. I usually do Arrange-Assert-Act-Assert.
<ul>
<li>This is also known as Given-When-Then in Behaviour-Driven Development (BDD) which uses the friendly english language to express the requirements.</li>
</ul>
</li>
</ul>
<h2 id="automated-code-review"><a class="header" href="#automated-code-review">Automated Code Review</a></h2>
<p>Who? The machine runs it for everyone</p>
<p>What?</p>
<ul>
<li>Static code analysis</li>
<li>Data-flow analysis?</li>
<li>Code coverage</li>
</ul>
<p>When?</p>
<ul>
<li>Git pre-commit hook</li>
<li>Local (manual run)</li>
<li>Code review interface</li>
<li>Continuous Integration (merger) runner</li>
</ul>
<h2 id="how-to-mock"><a class="header" href="#how-to-mock">How to Mock</a></h2>
<p>Don't. Ref: <a href="https://www.youtube.com/watch?v=Xu5EhKVZdV8">https://www.youtube.com/watch?v=Xu5EhKVZdV8</a></p>
<p>https://www.youtube.com/watch?v=3MNVP9-hglc &quot;The End Of Object Inheritance &amp; The Beginning Of A New Modularity&quot; here?</p>
<p>How to Test: <a href="https://www.destroyallsoftware.com/talks/boundaries">https://www.destroyallsoftware.com/talks/boundaries</a></p>
<p>Imperative shell = integration tests of the shell which tie together all the dependencies (no logic; no code paths to test) - that's what they're good at.</p>
<p>Functional core = unit-tests of all that messy logic (that's what they're good at)</p>
<h2 id="test-doubles"><a class="header" href="#test-doubles">Test Doubles</a></h2>
<p><a href="https://scribe.rip/m/global-identity-2?redirectUrl=https%3A%2F%2Fblog.pragmatists.com%2Ftest-doubles-fakes-mocks-and-stubs-1a7491dfa3da">https://scribe.rip/m/global-identity-2?redirectUrl=https%3A%2F%2Fblog.pragmatists.com%2Ftest-doubles-fakes-mocks-and-stubs-1a7491dfa3da</a></p>
<ul>
<li>Dummy â€” anything not used</li>
<li>Fakes â€” working implementation with shortcuts (test for state)</li>
<li>Stubs â€” answers queries with predefined data</li>
<li>Spies â€” stubs that record how they were called</li>
<li>Mocks â€” verify calls against a specification (test for behaviour)</li>
</ul>
<h3 id="how-to-choose-between-these"><a class="header" href="#how-to-choose-between-these">How to choose between these?</a></h3>
<p>There's different schools:</p>
<ul>
<li><a href="https://scribe.rip/@adrianbooth/test-driven-development-wars-detroit-vs-london-classicist-vs-mockist-9956c78ae95f">https://scribe.rip/@adrianbooth/test-driven-development-wars-detroit-vs-london-classicist-vs-mockist-9956c78ae95f</a></li>
<li><a href="https://martinfowler.com/articles/mocksArentStubs.html">https://martinfowler.com/articles/mocksArentStubs.html</a></li>
<li><a href="https://tyrrrz.me/blog/fakes-over-mocks">https://tyrrrz.me/blog/fakes-over-mocks</a></li>
</ul>
<p>Don't use test doubles for what you own. Only mock/fake external dependencies.</p>
<p>You own your own database, so you can use the real thing for tests.</p>
<p>You don't own a 3rd party API, so you need to use a fake for it (or mock it).</p>
<p>â€œMocking introduces assumptions, which introduces riskâ€. You are assuming the client library is implemented right, you are assuming all boundaries are solid, you are assuming you know how the library actually behaves.</p>
<h3 id="more-ideas"><a class="header" href="#more-ideas">More ideas</a></h3>
<p><a href="https://www.jamesshore.com/v2/projects/nullables/testing-without-mocks">https://www.jamesshore.com/v2/projects/nullables/testing-without-mocks</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture-patterns"><a class="header" href="#architecture-patterns">Architecture Patterns</a></h1>
<ul>
<li>Functional core, imperative shell/stateful surface (<a href="https://www.destroyallsoftware.com/talks/boundaries">Boundaries</a>)
<ul>
<li>Soft introduction: <a href="https://www.youtube.com/watch?v=DJtef410XaM">The Clean Architecture in Python</a> [Talk Notes]</li>
</ul>
</li>
<li>imperative and procedural vs oo.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="apis"><a class="header" href="#apis">APIs</a></h1>
<p>RESTful API, HTTP/Web API, TCP/Socket API - RPCs</p>
<h2 id="rest"><a class="header" href="#rest">REST</a></h2>
<blockquote>
<p>I would suggest RESTful APIs for CRUD-based applications, not for DDD-based applications.</p>
</blockquote>
<p>A set of patterns and guidelines (a software architectural style). The transport protocol is not defined, but universally REST is used as REST-over-HTTP.</p>
<p>A RESTful API<sup class="footnote-reference"><a href="#1">1</a></sup> is about <em>resources</em><sup class="footnote-reference"><a href="#2">2</a></sup>, where resources are <em>hypermedia</em>. Note that URLs are resources (not verbs/actions). You should spend your time defining the <a href="https://www.iana.org/assignments/media-types/media-types.xhtml">media types</a> used for resource representations, which includes the <a href="https://www.iana.org/assignments/link-relations/link-relations.xhtml">link relations</a> that the resource may contain.</p>
<p>The resources should not depend on the underlying domain/implementation objects. Create resources that make sense in the context of the API - they can be anything you can think of, for example a <em>process</em> can be a resource, especially if you want to ask questions about the state of the process.</p>
<p>HATEOAS means clients know one entry point (the bookmark) and the media types used for resource representations beforehand. What does the entry point return? In theory this allows you to control your namespace at will (i.e. changing object hierarchies or resource names at will); in practise clients may hardcode URLs and you need backwards-compatibility during the transition to a new URL namespace anyway. It also allows you to specify actions that may dynamically change depending on the resource's state. You may want to use <a href="https://tools.ietf.org/html/rfc5988" title="IETF RFC describing link relations between resources">links in headers</a>. In practise, decisions are made when the api integration code is written, not at run-time, as opposed to how we use links in web. HATEOAS requires hypermedia-aware media types such as HTML, Atom and SVG - hyperlinks, which XML and JSON don't define though there certain extensions to these that do. It genuinely puts theory over practise, and as it is uncommon it is actually slightly developer unfriendly.</p>
<p>Version via content-type headers: <code>application/vnd.mycompany.myapp.myresource+json; version=1.0</code> (or just a completely custom header); or inside the URL (hostname, <strong>path</strong> or query parameter). Note that, <code>application/json</code> is indeed a media type, but it is incomplete because it would only describe the data format, while (almost always) special processing is required for the content. Roy Fieldings says to version inside the hostname as the next version is a new system.</p>
<h3 id="pragmatic-advice"><a class="header" href="#pragmatic-advice">Pragmatic Advice</a></h3>
<ul>
<li>Don't use HATEOAS.</li>
<li>Version inside the URL path, <code>/api/v1/</code>.</li>
<li>Use the <code>Accept</code> HTTP header (and perhaps a query parameter) to change the media type of the response, e.g. XML. (Perhaps even an extension <code>/123.json</code>.)</li>
<li>Requests should be URL-encoded by default, JSON-encoded requests should require <code>Content-Type: application/json</code>.</li>
<li>Use HTTP status codes. Consider: 200, 201, 202, 204, 301, 304, 400, 401, 403, 404, 405, 409, 410, 412, 415, 422, 429.</li>
<li>Use the <code>Location</code> header for 201.</li>
<li>Specify a consistent error response on 4xx which includes a code, a human-readable message, and in the case of validation errors, a list of them.</li>
<li>Use explicit <code>Idempotency-Key</code>  HTTP headers for POST when necessary. (NB: every write should be idempotent due to network partitions.)</li>
<li>Prevent race-conditions with <code>ETag</code> and <code>If-Match</code> headers.</li>
<li>Always use plural forms for collections even when it doesn't make sense, e.g. <code>/people</code>.</li>
<li>Allow nested objects to be expanded, e.g. with an <code>?expand[]=friends.name</code> query parameter.</li>
<li>Allow fields to be explicitly specified, e.g. with a <code>?fields[]=age</code> query parameter.</li>
<li>Handle filtering, sorting and searching on collections via query parameters, e.g. <code>/people?q=john&amp;state=active&amp;sort[]=name,-date</code>. (i.e. not hierarchical sub-paths)</li>
<li>Consider aliasing query common parameters as a sub-resource path.</li>
<li>Avoid envelopes - HTTP already has them. For example, for pagination use links-in-headers, e.g. <code>Link: &lt;https://example.com/v1/people?page=3&gt;; rel=&quot;next&quot;, &lt;https://example.com/v1/people?page=50&gt;; rel=&quot;last&quot;</code> (first, last, next, previous), and a custom HTTP header for the total count like <code>X-Total-Count</code> .</li>
<li>How to paginate exactly?</li>
<li>Use POST/PUT/PATCH appropriately.</li>
<li>Use POST on collections to insert. Use PUT (idempotent) on specific resource path to create/update, and PATCH for partial updates.</li>
<li>PUT/POST/PATCH should return the new resource representation. In the case of HTTP 201, use the <code>Location</code> header.</li>
<li>If rate-limiting, use headers like <code>X-Rate-Limit-Limit</code> , <code>X-Rate-Limit-Remaining</code> , and <code>X-Rate-Limit-Reset</code>  (in seconds).</li>
<li>Use HTTP Basic Auth, if possible.</li>
<li>Use HTTP caching, e.g. <code>ETag</code> , and <code>Last-Modified</code> (with the appropriate vary and privacy settings).</li>
<li>Return pretty (indented) responses (gzip covers size concerns).</li>
<li>Return a request ID used for support queries as a HTTP header.</li>
<li>Documentation should show examples of complete request-response cycles, including copy-and-pastable code.</li>
<li>Clients should be informed of deprecation schedules (in the docs) and of updates (through blogs/changelogs/mailing lists).</li>
<li>When all else fails, and you really need an action, PATCH a field on the resource, use a sub-resource path, or, in extreme cases, create a new non-RESTful endpoint.</li>
</ul>
<p>Alternative: GraphQL (see <a href="https://githubengineering.com/the-github-graphql-api/">GitHub's blog post</a>).</p>
<p>TBD: <a href="https://www.thoughtworks.com/insights/blog/rest-api-design-resource-modeling">REST without PUT and PATCH</a>. The idea that clients shouldn't even manipulate the resource representation directly, but instead signal intents via new creation or update resources, e.g. an intent to change the resource, ChangeOfName vs PATCH person.name. The former allows for clear auditing/question asking of the process, eventual consistency and</p>
<p>Representational State Transfer (REST):</p>
<ul>
<li>separates concerns - data storage from user interface - client-server, allowing components to evolve separately.</li>
<li>is stateless - the request must contain all the information and cannot take advantage of stored context on the server, allowing for increased reliability (eases recovery), visibility (eases debugging) and scalability (no persistent state on server to preserve)</li>
<li>has a cache</li>
<li>uniform interface - <em><strong>simplifies development despite inefficiency due to standardised formats</strong></em></li>
<li>layered (e.g. load-balancers)</li>
</ul>
<h3 id="examples"><a class="header" href="#examples">Examples</a></h3>
<ul>
<li><a href="https://www.twilio.com/docs/usage/api">Twilio</a></li>
<li>Stripe</li>
</ul>
<h3 id="safety"><a class="header" href="#safety">Safety</a></h3>
<p>Safe: No side-effects (no server state change beyond trivial things like logging); Idempotent: Safely Repeatable.</p>
<p>Pure Read [REST:GET] - Safe</p>
<p>Stateful Reads [GET] - pure functions that need computational resources of server; cursor in databases; logging/analytics/paywalls; rate limiting APIs.</p>
<p><em><strong>Idempotent Write</strong></em> [PUT/DELETE] - you can safely throw these at the server.</p>
<p>Non-idempotent Write (dangerous) [POST-made idempotent with UUID] - in the event of a network partition you could have a serious problem.</p>
<h2 id="versioning-pattern"><a class="header" href="#versioning-pattern">Versioning Pattern</a></h2>
<p>Adapt new response to old response - pipeline, infinite support. See stripe &lt;TBD&gt;</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Originally described by Roy Fielding in his <a href="https://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm">dissertation</a> in 2000</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>The exact meanings of words like &quot;representation&quot; are described in Fielding's <a href="https://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm#tab_5_1">REST data elements table</a></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="agile"><a class="header" href="#agile">&quot;Agile&quot;</a></h1>
<ul>
<li><a href="http://agileforall.com/wp-content/uploads/2012/01/Story-Splitting-Flowchart.pdf">Split stories into vertical slices</a> to deliver fast</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="refactoring"><a class="header" href="#refactoring">Refactoring</a></h1>
<p>Notes from <em>Refactoring: Improving the Design of Existing Code, Second Edition</em>.</p>
<blockquote>
<p>&quot;The whole purpose of refactoring is to make us program faster, producing more value with less effort.&quot;<br />
Refactoring p56, Martin Fowler</p>
</blockquote>
<blockquote>
<p>&quot;for each desired change, make the change easy (warning: this may be hard), then make the easy change&quot;<br />
Kent Beck, Twitter</p>
</blockquote>
<blockquote>
<p>paraphrasing: going 20 miles north, 100 miles east on the motorway and back down is faster than going 100 miles east through the woods. &quot;sometimes you need to say, 'wait, I need to ceck the map and find the quickest route'.&quot;</p>
<p>Refactoring p51, Jessica Kerr</p>
</blockquote>
<h2 id="key-ideas"><a class="header" href="#key-ideas">Key Ideas</a></h2>
<ul>
<li>A refactoring is a small change to the structure of the code to make it easier to understand and cheaper to modify without modifying its observable behaviour.</li>
<li>This means, the codebase is <em>never</em> left in a broken state, and you can always stop refactoring even if you haven't finished.</li>
<li>Change-Compile-Test-Commit.</li>
<li>(When you succumbed to the temptation of making a larger multi-step refactoring in one go and the tests fail, simply revert the code and do the smaller steps!)</li>
<li>The rule of three: the first time you just do it, the second time you wince but you do it anyway, and the third time you refactor.</li>
<li>Design Stamina Hypothesis.</li>
<li>Two hats: two mutually exclusive activities of &quot;adding functionality&quot; and &quot;refactoring&quot;. The former mostly involves adding new tests and getting them to work, the latter doesn't need new tests to be added (unless you find some were missing).</li>
<li>The distinct types of <em>opportunistic</em> refactoring (following the boy-scout principle):
<ul>
<li>Preparatory refactoring - making it easier to add a feature</li>
<li>Comprehension refactoring - making code easier to understand</li>
<li>Litter-pickup refactoring - coming across bad code</li>
</ul>
</li>
</ul>
<p>Don't justify refactoring in terms of &quot;clean code&quot;, &quot;good engineering practice&quot;, or other moral reasons. Instead, communicate with the core economic benefits: it makes us faster to add features and faster to fix bugs.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="documentation"><a class="header" href="#documentation">Documentation</a></h1>
<p>This: <a href="https://www.divio.com/blog/documentation/">https://www.divio.com/blog/documentation/</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estimating"><a class="header" href="#estimating">Estimating</a></h1>
<blockquote>
<p><strong>Hofstadter's Law</strong> It always takes longer than you expect, even when you take into account Hofstadter's Law.</p>
</blockquote>
<p>You can, to a certain degree, trade time for more accuracy. Propose that to your manager.</p>
<h2 id="how-can-we-increase-the-accuracy"><a class="header" href="#how-can-we-increase-the-accuracy">How can we increase the accuracy?</a></h2>
<ol>
<li>Estimate hierarchically, break down tasks until the leaf nodes are 4 hours or less.</li>
<li>Use how long similar past tasks took to estimate new tasks.</li>
<li>Include time for other work: meetings, code review, writing tests, debugging, presenting, etc.</li>
<li>Derisk unpredictable things ahead of time using spikes.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="domain-driven-development"><a class="header" href="#domain-driven-development">Domain-Driven Development</a></h1>
<p>I need to shove these links somewhere:</p>
<p><a href="https://github.com/pyeventsourcing/eventsourcing">https://github.com/pyeventsourcing/eventsourcing</a></p>
<p><a href="https://www.cosmicpython.com/">https://www.cosmicpython.com/</a></p>
<p><a href="https://abdullin.com/post/event-sourcing-specifications/">https://abdullin.com/post/event-sourcing-specifications/</a></p>
<p><a href="https://dzone.com/articles/cqrs-is-an-anti-pattern-for-ddd">https://dzone.com/articles/cqrs-is-an-anti-pattern-for-ddd</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cpu"><a class="header" href="#cpu">CPU</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sorting"><a class="header" href="#sorting">Sorting</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="strings"><a class="header" href="#strings">Strings</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="avoid-using-makefiles-as-a-script-runner"><a class="header" href="#avoid-using-makefiles-as-a-script-runner">Avoid using Makefiles as a Script Runner</a></h1>
<p>The purpose of a makefile is to create a directed acyclic graph of dependencies to build files.</p>
<ul>
<li>it is yet another custom syntax with its own caveats to learn</li>
<li>long shell scripts must be separate files or badly inlined</li>
<li>most targets will be <code>.PHONY</code> defeating the purpose of the tool</li>
<li>makefiles use <code>mtime</code> to detect changes which can be unreliable for when a team develops using git branches</li>
<li>makefiles usually need additional configuration (help, .PHONY, flags, failure)</li>
<li><code>make</code> may require explicit installation on a developer's system</li>
</ul>
<p>Instead, just use bash scripts in a folder.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="django-orm"><a class="header" href="#django-orm">Django ORM</a></h1>
<p>Django has tight integration between relational databases, HTML, and REST APIs. By defining one model, you get a web interface to modify it, a database interface to query or modify it, and HTML interfaces (forms) to query/modify it. This is fantastic for rapid development.</p>
<p>So, if you're in that tightly-coupled ecosystem and legitimately making use of it, then bear those pros in mind.</p>
<p>I want to talk about when you're not using Django's Admin interface, and HTML forms and templates. This is much more likely for any large application.</p>
<p>Related Article: <a href="https://calpaterson.com/activerecord.html">https://calpaterson.com/activerecord.html</a></p>
<h2 id="the-pain"><a class="header" href="#the-pain">The pain</a></h2>
<p>Django's ORM follows</p>
<p>I want to talk about Django's ORM and my explain my thoughts on why I think it should be avoided.</p>
<h2 id="its-not-sql"><a class="header" href="#its-not-sql">It's not SQL</a></h2>
<p>Django goes out of its way to hide SQL, database principles and Python's standard interface to databases. This means less transferable knowledge is learnt, and actual understanding about databases is harder to come by.</p>
<p>SQLAlchemy maps much more directly onto</p>
<h3 id="joins"><a class="header" href="#joins">Joins</a></h3>
<p>Let's do a simple join:</p>
<pre><code class="language-python">Books.objects.filter(author__name=&quot;django&quot;)
</code></pre>
<p>It's not obvious at all that a join is happening.</p>
<h3 id="aggregates"><a class="header" href="#aggregates">Aggregates</a></h3>
<pre><code class="language-python">Book.objects.annotate(Count('chapters'))
</code></pre>
<p>vs</p>
<pre><code>SELECT book.*, count(chapter.id)
FROM book
JOIN chapter using (book_id);
</code></pre>
<h2 id="its-not-pythons-dbapi"><a class="header" href="#its-not-pythons-dbapi">It's not Python's DBAPI</a></h2>
<p>...</p>
<h2 id="it-hides-the-global-state"><a class="header" href="#it-hides-the-global-state">It hides the global state</a></h2>
<p>From <strong>anywhere</strong> you can call the database:</p>
<pre><code class="language-python">Book.objects.create()
</code></pre>
<p>That is actually pretty bad, but further this demonstrates that the database connection, cursor, session, transaction are all hidden away.</p>
<pre><code class="language-python">with Session(engine) as session:
    session.add(book)
    session.commit()
</code></pre>
<p>Further reading: https://docs.sqlalchemy.org/en/14/orm/session_transaction.html?highlight=savepoint#session-level-vs-engine-level-transaction-control</p>
<h2 id="it-uses-autocommit"><a class="header" href="#it-uses-autocommit">It uses autocommit</a></h2>
<p>By default, Django uses autocommit where every statement is immediately committed. This is against the PEP 249 standard and usually not what you want.</p>
<p>Complex applications often perform complex queries and mutations that must be kept consistent, and thus</p>
<p>To use a transaction:</p>
<pre><code class="language-python">with transaction.atomic(durable=True):
    obj1.save()
    obj2.save()
</code></pre>
<p>SQLAlchemy ORM:</p>
<pre><code class="language-python">with session.begin():
    session.add(obj1)
    session.add(obj2)
</code></pre>
<p>Further reading: https://docs.sqlalchemy.org/en/14/changelog/migration_20.html#library-level-but-not-driver-level-autocommit-removed-from-both-core-and-orm</p>
<h2 id="it-mixes-together-too-many-things"><a class="header" href="#it-mixes-together-too-many-things">It mixes together too many things</a></h2>
<ul>
<li>Model fields can define <code>blank</code> which is a client-side validation.</li>
<li>Model fields can define <code>verbose_name</code> which is for displaying to users.</li>
</ul>
<h2 id="its-not-clear-when-queries-are-executed"><a class="header" href="#its-not-clear-when-queries-are-executed">It's not clear when queries are executed</a></h2>
<p>There are a lot of rules on when a query is actually executed. I'll grant they're pretty straightforward, but there are edge cases to ensure multiple queries are not executed by accident.</p>
<pre><code class="language-python">results = Book.objects.all()
if len(results) &gt; 2:
    print(results)
</code></pre>
<p>In comparison, with SQLAlchemy there is an explicit execute:</p>
<pre><code class="language-python">results = session.execute(select(Book))
</code></pre>
<h2 id="complex-queries-are-nasty"><a class="header" href="#complex-queries-are-nasty">Complex queries are nasty</a></h2>
<p>SQLAlchemy has strong support for niche features in comparison to Django.</p>
<h2 id="transactions-are-a-mess"><a class="header" href="#transactions-are-a-mess">Transactions are a mess</a></h2>
<p>Though in Django 3.2, they finally added <code>transaction(durable=True)</code>, the whole transaction system is opaque.</p>
<h2 id="its-not-ddd-compatible"><a class="header" href="#its-not-ddd-compatible">It's not DDD-compatible</a></h2>
<p>Django forces you to define your models in the root of an &quot;app&quot;, while with a good code structure the database models will be hidden away.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="read-modify-write-patterns-in-python"><a class="header" href="#read-modify-write-patterns-in-python">Read-Modify-Write Patterns in Python</a></h1>
<p>Read-Modify-Write can cause &quot;lost updates&quot;. Solutions, in order of preference:</p>
<ol>
<li>Use calculated updates</li>
<li>Use optimistic row-level locks (version column)</li>
<li>Use pessimistic row-level locks</li>
<li>Use database locks for higher-level issues</li>
<li>Use external locks</li>
<li>Use serialisable transactions</li>
</ol>
<h2 id="calculated-updates"><a class="header" href="#calculated-updates">Calculated updates</a></h2>
<pre><code class="language-sql">UPDATE table SET a = a + 1 WHERE id = 1;
</code></pre>
<p>These are ideal because no read occurs and they are atomic.</p>
<p>If there are zero updated columns, then you know someone else beat you to it.</p>
<p>It's possible to do more complicated variants that are safe to other kinds of race conditions:</p>
<pre><code class="language-sql">UPDATE balance
SET balance = balance - 100
WHERE id = 1 AND balance &gt;= 100;
</code></pre>
<p>In python...</p>
<h2 id="use-optimistic-row-level-locks-version-column"><a class="header" href="#use-optimistic-row-level-locks-version-column">Use optimistic row-level locks (version column)</a></h2>
<p>These are better in read-heavy situations (which is typically the case).</p>
<p>A variant on relative updates with an explicit version column.</p>
<pre><code class="language-sql">UPDATE book
SET
    name = :name,
    version = version + 1
WHERE id = :id AND version = :current_version
</code></pre>
<p>Note: only one version of an entity exists at any time, otherwise other kinds of race conditions are possible!</p>
<p>In Python, SQLAlchemy has good built-in support for this <a href="https://docs.sqlalchemy.org/en/14/orm/versioning.html">https://docs.sqlalchemy.org/en/14/orm/versioning.html</a> and can raise <code>StaleDataError</code>.</p>
<h2 id="use-pessimistic-row-level-locks"><a class="header" href="#use-pessimistic-row-level-locks">Use pessimistic row-level locks</a></h2>
<p>These are better in write-heavy situations. In general, they should be avoided because they create long-running transactions which interfere with database migrations.</p>
<p>In Python, the pattern for these would be:</p>
<pre><code class="language-python">def create(session: Session: book_new: BookNew) -&gt; BookOut:
    model = convert_book_new_to_model(book_new)
    result = session.add(model)
    return _convert_one(result)

def get_by_id(session: Session, id_: int) -&gt; BookOut:
    result = session.execute(Book.id=id_)
    return _convert_one(result)

def get_locked_by_id(session: Session, id_: int) -&gt; Tuple[BookOut, BookUpdate]:
    result = session.execute(
        select(Book)
        .filter(Book.id=id_)
        .with_for_update()
        .one_or_none()
    )
    return _convert_one(result)

def save(
    session: Session, old_book_out: BookOut, book_update: BookUpdate
) -&gt; BookOut:
    assert book_out.id == book_update.id
    model = _convert_book_update_to_model(book_update)
    new_book_out = session.add(model)
    publish_book_updated(session, old_book_out, new_book_out)
    return _convert_one(new_book_out)


# Usage
book_out, book_update = get_locked_by_id(session, 1)
book_update.name = &quot;Super Book&quot;
save(session, book_out, book_update)
</code></pre>
<ul>
<li>Avoid locks where they are unnecessary</li>
<li>Impossible to update objects without getting a lock</li>
<li>Impossible to update objects without publishing an event (if desired)</li>
<li>Published events have access to old and new state</li>
<li>Transactions are managed outside these methods</li>
</ul>
<p>Note that where there are child objects (say of a DDD aggregate), then the row-level lock can just be taken on the root entity, trusting your database-access layer to consistently take locks.</p>
<h2 id="use-database-locks"><a class="header" href="#use-database-locks">Use database locks</a></h2>
<p>Use a PG Advisory lock consistently for higher-level transactions where the above approaches are not appropriate.</p>
<p>In Python...</p>
<h2 id="use-external-locks"><a class="header" href="#use-external-locks">Use external locks</a></h2>
<p>For example, use Redis for locking. Don't do this if you are locking inside of one database, in that case just use the in-built database lock.</p>
<h2 id="use-serialisable-transactions"><a class="header" href="#use-serialisable-transactions">Use serialisable transactions</a></h2>
<p>I've not evaluated these myself, but they do seriously limit throughput and they abort the transaction (similar to optimistic locking)</p>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ol>
<li><a href="https://www.2ndquadrant.com/en/blog/postgresql-anti-patterns-read-modify-write-cycles/">https://www.2ndquadrant.com/en/blog/postgresql-anti-patterns-read-modify-write-cycles/</a></li>
<li><a href="https://ketanbhatt.com/db-concurrency-defects/">https://ketanbhatt.com/db-concurrency-defects/</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reading-materials"><a class="header" href="#reading-materials">Reading Materials</a></h1>
<p>A collection of further, high-quality reading material:</p>
<ul>
<li><a href="https://learngitbranching.js.org/">Git Branching Tutorial</a> - learn git properly</li>
<li><a href="https://git-scm.com/book/">Git Book</a> - learn git thoroughly</li>
<li><a href="https://www.homenethowto.com/">Networking</a> - basics of networks from the perspective of your home</li>
<li><a href="http://gameprogrammingpatterns.com/">Game Programming Patterns</a> - useful for more than just games</li>
<li><a href="https://github.com/lfit/itpol/blob/master/linux-workstation-security.md">Linux Workstation Security</a> - a checklist for security (should adapt for your own situation)</li>
</ul>
<p>Books:</p>
<ul>
<li>Refactoring (2nd Edition) by Martin Fowler.. Not even out.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-great-references-list"><a class="header" href="#the-great-references-list">The Great References List</a></h1>
<ul>
<li>
<p><a href="http://www.gigamonkeys.com/book/beyond-exception-handling-conditions-and-restarts.html">http://www.gigamonkeys.com/book/beyond-exception-handling-conditions-and-restarts.html</a></p>
</li>
<li>
<p><a href="https://waveform.org.uk/presentations/sql/#/">https://waveform.org.uk/presentations/sql/#/</a></p>
</li>
<li>
<p><a href="https://testing.googleblog.com/2010/12/test-sizes.html">https://testing.googleblog.com/2010/12/test-sizes.html</a></p>
</li>
<li>
<p><a href="http://istqbexamcertification.com/what-is-acceptance-testing/">http://istqbexamcertification.com/what-is-acceptance-testing/</a></p>
</li>
<li>
<p><a href="http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven">http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven</a></p>
</li>
<li>
<p><a href="http://www.butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod">http://www.butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod</a></p>
</li>
<li>
<p><a href="https://code.tutsplus.com/tutorials/solid-part-2-the-openclosed-principle--net-36600">https://code.tutsplus.com/tutorials/solid-part-2-the-openclosed-principle--net-36600</a></p>
</li>
<li>
<p><a href="http://www.informit.com/articles/article.aspx?p=1566460">http://www.informit.com/articles/article.aspx?p=1566460</a></p>
</li>
<li>
<p><a href="https://githubengineering.com/the-github-graphql-api/">https://githubengineering.com/the-github-graphql-api/</a> #rest #graphql #api</p>
</li>
<li>
<p><a href="https://capnproto.org/">https://capnproto.org/</a> #api</p>
</li>
<li>
<p><a href="https://restful-api-design.readthedocs.io/">https://restful-api-design.readthedocs.io/</a> #rest #api</p>
</li>
<li>
<p><a href="https://www.troyhunt.com/your-api-versioning-is-wrong-which-is/">https://www.troyhunt.com/your-api-versioning-is-wrong-which-is/</a> #rest #api</p>
</li>
<li>
<p><a href="https://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api">https://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api</a> #rest #api</p>
</li>
<li>
<p><a href="https://medium.com/@rdsubhas/pitiful-restful-urls-5d576ffccb98">https://medium.com/@rdsubhas/pitiful-restful-urls-5d576ffccb98</a> #rest #api</p>
</li>
<li>
<p><a href="http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven">http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven</a> #rest #api</p>
</li>
<li>
<p><a href="http://blog.codepipes.com/testing/software-testing-antipatterns.html">http://blog.codepipes.com/testing/software-testing-antipatterns.html</a> #tdd #antipattern</p>
</li>
<li>
<p><a href="https://www.programmableweb.com/news/rest-api-design-put-type-content-type/2011/11/18">https://www.programmableweb.com/news/rest-api-design-put-type-content-type/2011/11/18</a> #rest #api</p>
</li>
<li>
<p><a href="https://www.thoughtworks.com/insights/blog/rest-api-design-resource-modeling">https://www.thoughtworks.com/insights/blog/rest-api-design-resource-modeling</a> #rest #api</p>
</li>
<li>
<p>[https://github.com/tfredrich/RestApiTutorial.com/blob/master/media/RESTful Best Practices-v2_0.odt](https://github.com/tfredrich/RestApiTutorial.com/blob/master/media/RESTful Best Practices-v2_0.odt) #rest #api</p>
</li>
<li>
<p><a href="http://mark-kirby.co.uk/2013/creating-a-true-rest-api/">http://mark-kirby.co.uk/2013/creating-a-true-rest-api/</a> #rest #api</p>
</li>
<li>
<p><a href="https://sookocheff.com/post/testing/improving-test-coverage-with-exploratory-outcomes/">https://sookocheff.com/post/testing/improving-test-coverage-with-exploratory-outcomes/</a> #tdd</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=Api6dFMlxAA">https://www.youtube.com/watch?v=Api6dFMlxAA</a> (presentation on tiling window managers) #wms #twms</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=S1bJpsS27Qk">https://www.youtube.com/watch?v=S1bJpsS27Qk</a> (configuring VyOS - open source router) #router</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=wf-BqAjZb8M">https://www.youtube.com/watch?v=wf-BqAjZb8M</a> (&quot;Beyond PEP8&quot; @Raymond Hettinger) #python</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=9zinZmE3Ogk">https://www.youtube.com/watch?v=9zinZmE3Ogk</a> (&quot;Keynote on Concurrency&quot; @Raymond Hettinger) #python</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=EiOglTERPEo">https://www.youtube.com/watch?v=EiOglTERPEo</a> (&quot;Super Considered Super&quot; @Raymond Hettinger) #python</p>
</li>
<li>
<p>Once: <a href="https://www.youtube.com/watch?v=T-TwcmT6Rcw">https://www.youtube.com/watch?v=T-TwcmT6Rcw</a> (&quot;Dataclasses&quot; @Raymond Hettinger) #python</p>
</li>
<li>
<p>Once: <a href="https://www.youtube.com/watch?v=p33CVV29OG8">https://www.youtube.com/watch?v=p33CVV29OG8</a> (&quot;Modern Dictionaries&quot; @Raymond Hettinger) #python</p>
</li>
<li>
<p><a href="https://software-carpentry.org/lessons/">https://software-carpentry.org/lessons/</a> #learning</p>
</li>
<li>
<p><a href="https://swcarpentry.github.io/make-novice/">https://swcarpentry.github.io/make-novice/</a> #learning</p>
</li>
<li>
<p><a href="https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying">https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying</a> #data #data #data</p>
</li>
<li>
<p><a href="https://www.obeythetestinggoat.com/book/preface.html">https://www.obeythetestinggoat.com/book/preface.html</a> #tdd #book</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=DJtef410XaM">https://www.youtube.com/watch?v=DJtef410XaM</a> (&quot;The Clean Architecture in Python&quot; @Brandon Rhodes) #architecture #python</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=PpyPa92r44s">https://www.youtube.com/watch?v=PpyPa92r44s</a> (&quot;Practical Design Patterns in Docker Networking&quot;) #docker #networking</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=sSm2dRarhPo">https://www.youtube.com/watch?v=sSm2dRarhPo</a> (&quot;Microservices + Events + Docker = A PerfectTrio&quot;) #DDD #microservices #architecture</p>
</li>
<li>
<p>https://www.youtube.com/watch?v=KVKufdTphKs (&quot;Python's Infamous GIL&quot; @Larry Hastings PyCon 2015) #python</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="talk-notes"><a class="header" href="#talk-notes">Talk Notes</a></h1>
<ul>
<li>
<p><a href="https://www.youtube.com/watch?v=DJtef410XaM">The Clean Architecture in Python</a> - Brandon Rhodes @ PyOhio 2014</p>
<ul>
<li>A soft introduction to domain-driven development, imperative shell/functional core</li>
<li>Burying I/O into a sub-procedure hides the complexity of the procedure</li>
<li>Decoupling I/O <em>above your procedure</em> simplifies the implementation, allows for easier unit-testing, better composability</li>
<li>The latter decouples the I/O, the former</li>
<li>Comments are information that can be moved into the code itself (self-documenting)</li>
<li>Two methods of avoiding decoupled I/O: dependency injection and mocking</li>
<li>Dependency injection (2004 Martin Fowler: make the I/O library or function a parameter) leads to DI frameworks because all the dependencies need to be injected all the way down into the very depths of your code (they could use anything they want). The paramters just need to be passed along.</li>
<li>The other problem with DI for testing is that you are not testing the real library</li>
<li>Mock is similar.</li>
<li>DI/mock make you feel that you are fighting the structure of your program? Code smell.</li>
<li>A symptom of coupling - testing combinations of parameters</li>
<li>In DDD the deeper you go into a program, the closer to policies you should get. The shell should be mechanisms.</li>
<li>Isolated, simple data structures are passed across boundaries.</li>
<li>&quot;An imperative shell, that wraps and uses, your functional core&quot;</li>
<li>Procedural code: &quot;output as you run&quot;; functional code: stages producing data, that outputs at the end.</li>
<li>The biggest advantage of functional programming is that you can <em>see the data</em> between stages. &quot;Show code and hide models and I will be mystified; show models and hide code and it will be obvious&quot;</li>
<li>By working in stages - linking simple programs together - you can picture the output of each stage. It continually surfaces the result which can be easily checked. <strong>Our minds can picture the data easily.</strong></li>
<li>&quot;The coder can concentrate on one section of the program at a time, without the overall detailed program continually intruding&quot;</li>
<li>Immutable data structures lead to distributed computing: if you modify memory, you cannot move that code to another machine, but if you just accept data and return data then you can move that to another machine.</li>
<li>A function that takes an opaque, complex data structure is actually a disguised method.</li>
<li>Brief Python-specific details at the very end (generators, iterators, context managers).</li>
</ul>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=sSm2dRarhPo">Microservices + Events + Docker = A Perfect Trio</a> - Chris Richardson @ DockerCon 2016</p>
<ul>
<li>Monolithic applications become large, and you lose team autonomy and fast development because of conflicts between teams that contribute to the same codebase.</li>
<li>So, accelerate development with microservices.</li>
<li>But, microservices mean a distributed system: communication between services, partial failures, consistency between databases (no distributed transactions), testing is complicated, and DevOps is complex.</li>
<li>A shared database is not microservices because of tight coupling - conflicts between teams result in slowdowns and loss of team autonomy.</li>
<li>So, use event-driven architecture to maintain data consistency.</li>
<li>But you still have a dual-write problem (write to database and write to message broker).</li>
<li>So, use Event-Sourcing: it resolves data consistency, gives you reliable event publishing, gives you auditing, and eliminates ORM problems.</li>
<li>But, querying the event store directly can be extremely challenging.</li>
<li>So, resolve with Command Query Responsibility Segregation (CQRS) by splitting commands on the aggregate which produce events, from materialised views which consume events and provide a query API (backed with type of database)</li>
<li>Use Docker to simplify development and deployment.</li>
<li><a href="https://microservices.io">https://microservices.io</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-cultural-history-of-programming"><a class="header" href="#the-cultural-history-of-programming">The Cultural History of Programming</a></h1>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Magnetic-core_memory">Magnetic-Core Memory</a> used as RAM between 1955-1975 is the source of the term &quot;core memory&quot; or &quot;core dumps&quot;. </li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><ul>
<li>
<p>Socat - Create a listening service that forwards to a service inside a network namespace (socat is amazing): <code>/usr/bin/socat UNIX-LISTEN:/run/transmission.sock,fork exec:'ip netns exec NETNS socat STDIO tcp-connect\:127.0.0.1\:8080',nofork</code></p>
<ul>
<li>HTTP Client -&gt; [Unix Socket Server] ---- | Network Namespace Barrier | ----&gt; HTTP Server (localhost listening)</li>
</ul>
</li>
<li>
<p>strace -p PID - Look at calls between the process and the kernel</p>
</li>
<li>
<p>gdb, python-dbg - Look at stack traces live</p>
</li>
<li>
<p>TIL: <a href="https://news.ycombinator.com/item?id=17083879">https://news.ycombinator.com/item?id=17083879</a> &quot;My registrar suspended my domain because an abusive user was using a subdomain for phishing&quot;</p>
</li>
<li>
<p>Make Vim respect XDG - <a href="https://tlvince.com/vim-respect-xdg">https://tlvince.com/vim-respect-xdg</a></p>
</li>
<li>
<p>Write scripts, just flipping write them! <a href="https://www.youtube.com/watch?v=Jd8ulMb6_ls">https://www.youtube.com/watch?v=Jd8ulMb6_ls</a> &quot;Solve Your Problem with Sloppy Python&quot; @Larry Hastings</p>
</li>
<li>
<p>A product manager can buy software from their team, but they can also buy information like, &quot;Is X possible?&quot; or &quot;How many points to build Y?&quot; or &quot;How much support would be reduced if we did Z?&quot;.</p>
</li>
<li>
<p>Fira code for this ligatures: <a href="https://medium.com/@docodemore/an-alternative-to-operator-mono-font-6e5d040e1c7e">https://medium.com/@docodemore/an-alternative-to-operator-mono-font-6e5d040e1c7e</a></p>
</li>
<li>
<p><a href="http://learnyouanagda.liamoc.net/pages/introduction.html">http://learnyouanagda.liamoc.net/pages/introduction.html</a></p>
</li>
<li>
<p>camelCase, PascalCase, snake_case, kebab-case, CAPS_CASE.</p>
</li>
<li>
<p>Sudoers:<code>pccuser ALL=(ALL:ALL) NOPASSWD:/path/to/command &quot;&quot;</code>
pcuser = user or %group we are giving permission to
ALL= is the host (ALL works unless you are sharing file across hosts)
(ALL:ALL) is (user-we-can-command-as:group-we-can-command-as), i.e. sudo -u user -g group. If omitted only root. Can use just (ALL)
NOPASSWD: is tags
command may be &quot;ALL&quot;.
&quot;&quot; prevents command parameters (do not use when specifying parameters)</p>
<p>-&gt; User Host = (Runas) Command</p>
<ul>
<li>Example (placed after NO-NOPASSWD): <code>%wheel ALL=(root) NOPASSWD:/usr/bin/pacmatic -Syu</code></li>
</ul>
</li>
<li>
<p>microservices.io</p>
</li>
</ul>
<h2 id="python-ecosystem"><a class="header" href="#python-ecosystem">Python Ecosystem</a></h2>
<ul>
<li>stdlib 3.7 dataclasses (<a href="https://www.youtube.com/watch?v=T-TwcmT6Rcw">https://www.youtube.com/watch?v=T-TwcmT6Rcw</a> &quot;Dataclasses&quot; @Raymond Hettinger)
<ul>
<li>previously and still alternatively: attrs lib (has validators, converters and a few other features)</li>
</ul>
</li>
<li>pipenv (<a href="https://www.youtube.com/watch?v=GBQAKldqgZs">https://www.youtube.com/watch?v=GBQAKldqgZs</a> &quot;Pipenv&quot; @Kenneth Reitz)</li>
<li>pytest</li>
<li>typing: (mypy or pyre, MonkeyType) (<a href="https://www.youtube.com/watch?v=pMgmKJyWKn8">https://www.youtube.com/watch?v=pMgmKJyWKn8</a> &quot;Real World&quot; @Carl Meyer)</li>
<li>Instagram 2018 1.5mil lines of Python</li>
<li>linting complete: <a href="https://jeffknupp.com/blog/2016/12/09/how-python-linters-will-save-your-large-python-project/">https://jeffknupp.com/blog/2016/12/09/how-python-linters-will-save-your-large-python-project/</a>
<ul>
<li>Create based on project Daedalus.</li>
</ul>
</li>
<li><a href="https://awesome-python.com/">https://awesome-python.com/</a></li>
</ul>
<p><a href="https://github.com/ambv/black">https://github.com/ambv/black</a> - pycodestyle auto</p>
<h2 id="javascript-ecosystem"><a class="header" href="#javascript-ecosystem">JavaScript Ecosystem</a></h2>
<ul>
<li><a href="https://prettier.io/">https://prettier.io/</a> (there was another opinionated one?)
<ul>
<li><a href="https://standardjs.com/">https://standardjs.com/</a></li>
</ul>
</li>
</ul>
<h2 id="personality"><a class="header" href="#personality">Personality</a></h2>
<ul>
<li>
<p>Be likeable - <a href="https://news.ycombinator.com/item?id=16883882">https://news.ycombinator.com/item?id=16883882</a></p>
</li>
<li>
<p>Don't be a hero - <a href="https://al3x.net/posts/2010/01/09/dont-be-a-hero.html">https://al3x.net/posts/2010/01/09/dont-be-a-hero.html</a></p>
</li>
<li>
<p>On how to build an engineering culture - <a href="http://firstround.com/review/why-firing-brilliant-assholes-is-required-to-build-a-great-engineering-culture/">http://firstround.com/review/why-firing-brilliant-assholes-is-required-to-build-a-great-engineering-culture/</a></p>
</li>
<li>
<p>How to apologise(!). <a href="https://www.thecut.com/2017/06/these-apology-critics-want-to-teach-you-how-to-say-sorry.html">Source</a></p>
</li>
<li>
<p>An expression of regret, i.e. &quot;I'm sorry&quot;</p>
</li>
<li>
<p>An explanation (but not a justification)</p>
</li>
<li>
<p>An acknowledgement of responsibility (most important)</p>
</li>
<li>
<p>A declaration of repentance</p>
</li>
<li>
<p>An offer of repair</p>
</li>
<li>
<p>A request for forgiveness (least importance)</p>
</li>
</ul>
<p>Don't say: &quot;IF&quot;, &quot;I regret&quot;, Don't use passive voice. Say how you're going to make sure this doesn't happen again.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
